/// Views Start of ChampionDetailView.xaml.cs ///
﻿// No se necesita 'using System.Windows.Controls;' explícito si se califica abajo.

namespace SkinHunterWPF.Views
{
    public partial class ChampionDetailView : System.Windows.Controls.UserControl // Calificado aquí
    {
        public ChampionDetailView()
        {
            InitializeComponent();
        }
    }
}
/// Views End of ChampionDetailView.xaml.cs ///

/// Views Start of ChampionGridView.xaml.cs ///
﻿// No se necesita 'using System.Windows.Controls;' explícito si se califica abajo.

namespace SkinHunterWPF.Views
{
    public partial class ChampionGridView : System.Windows.Controls.UserControl // Calificado aquí
    {
        public ChampionGridView()
        {
            InitializeComponent();
        }
    }
}
/// Views End of ChampionGridView.xaml.cs ///

/// Views Start of OmnisearchDialog.xaml.cs ///
﻿namespace SkinHunterWPF.Views
{
    public partial class OmnisearchDialog : System.Windows.Controls.UserControl
    {
        public OmnisearchDialog()
        {
            InitializeComponent();
        }
    }
}
/// Views End of OmnisearchDialog.xaml.cs ///

/// Views Start of SkinDetailDialog.xaml.cs ///
﻿using System.Windows.Navigation;
using System.Diagnostics;
using System;
using System.Windows;

namespace SkinHunterWPF.Views
{
    public partial class SkinDetailDialog : System.Windows.Controls.UserControl
    {
        public SkinDetailDialog()
        {
            InitializeComponent();
        }

        private void Hyperlink_RequestNavigate(object sender, RequestNavigateEventArgs e)
        {
            try
            {
                Process.Start(new ProcessStartInfo(e.Uri.AbsoluteUri) { UseShellExecute = true });
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Failed to open hyperlink: {ex.Message}");
                System.Windows.MessageBox.Show($"Could not open link: {e.Uri.AbsoluteUri}", "Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            e.Handled = true;
        }
    }
}
/// Views End of SkinDetailDialog.xaml.cs ///

/// Views Start of ChampionDetailView.xaml ///
<UserControl x:Class="SkinHunterWPF.Views.ChampionDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:SkinHunterWPF.ViewModels"
             xmlns:m="clr-namespace:SkinHunterWPF.Models"
             xmlns:converters="clr-namespace:SkinHunterWPF.Converters"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=vm:ChampionDetailViewModel, IsDesignTimeCreatable=False}"
             d:DesignHeight="600" d:DesignWidth="1000">
    <Grid Background="{StaticResource WindowBackgroundColor}">

        <Grid Visibility="{Binding IsLoading, Converter={StaticResource InverseBooleanToVisibilityConverter}, FallbackValue=Collapsed}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Button Command="{Binding GoBackCommand}" Content="Back"
                    HorizontalAlignment="Left" VerticalAlignment="Top" Margin="15,15,0,0" Width="70"/>

            <StackPanel Grid.Row="0" Margin="0,10,0,20" Orientation="Horizontal" HorizontalAlignment="Center"
                        Visibility="{Binding Champion, Converter={StaticResource NullToVisibilityConverter}}">
                <Image Source="{Binding Champion.ChampionImageSource}" Width="80" Height="80" Stretch="Uniform" Margin="0,-43,15,0" RenderOptions.BitmapScalingMode="HighQuality"/>
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="{Binding Champion.Name}" Foreground="{StaticResource ForegroundColor}" FontSize="24" FontWeight="Bold"/>
                    <TextBlock Text="{Binding Champion.Title}" Foreground="{StaticResource ForegroundLightGray}" FontSize="16" FontStyle="Italic"/>
                    <TextBlock Text="{Binding Champion.ShortBio}" Foreground="{StaticResource ForegroundGray}" FontSize="12" TextWrapping="Wrap" MaxWidth="500" Margin="0,5,0,0"/>
                </StackPanel>

            </StackPanel>

            <ItemsControl Grid.Row="1" ItemsSource="{Binding Skins}"
                          VirtualizingPanel.IsVirtualizing="True" VirtualizingPanel.VirtualizationMode="Recycling"
                          HorizontalAlignment="Center" VerticalAlignment="Top" Margin="5">

                <ItemsControl.ItemsPanel>

                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal" ItemWidth="220" ItemHeight="255"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>

                    <DataTemplate DataType="{x:Type m:Skin}">

                        <Button Command="{Binding DataContext.SelectSkinCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                CommandParameter="{Binding}"
                                Style="{StaticResource ButtonTransparentStyle}" Margin="5">
                            <Border Style="{StaticResource CardBorderStyle}" Padding="0" Width="210" Height="220">
                                <Grid>
                                    <Image Source="{Binding TileImageUrl}" Height="195" Stretch="UniformToFill" VerticalAlignment="Top"
                                           RenderOptions.BitmapScalingMode="HighQuality"/>

                                    <Image Source="pack://application:,,,/Assets/legacy-icon.png" Width="24" Height="24" Opacity="0.8"
                                            HorizontalAlignment="Left" VerticalAlignment="Top" Margin="8"
                                            Visibility="{Binding IsLegacy, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <Image Source="pack://application:,,,/Assets/chroma-icon.png" Width="24" Height="24" Opacity="0.8"
                                            HorizontalAlignment="Right" VerticalAlignment="Top" Margin="8"
                                            Visibility="{Binding HasChromas, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                                    <Border VerticalAlignment="Bottom" Padding="8,3" HorizontalAlignment="Center">
                                        <StackPanel Orientation="Horizontal">
                                            <Image Source="{Binding RarityImageUrl}" Width="16" Height="16" Margin="0,0,5,0"
                                                   Visibility="{Binding RarityImageUrl, Converter={StaticResource NullToVisibilityConverter}}"/>
                                            <TextBlock Text="{Binding Name}" Foreground="{StaticResource ForegroundColor}" FontSize="13" FontWeight="SemiBold" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" TextAlignment="Center" Width="170" HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Border>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>

        <ProgressBar Style="{StaticResource LoadingProgressBarStyle}"
                      Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}" />
    </Grid>
</UserControl>
/// Views End of ChampionDetailView.xaml ///

/// Views Start of ChampionGridView.xaml ///
<UserControl x:Class="SkinHunterWPF.Views.ChampionGridView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:SkinHunterWPF.ViewModels"
             xmlns:m="clr-namespace:SkinHunterWPF.Models"
             xmlns:converters="clr-namespace:SkinHunterWPF.Converters"
             xmlns:vwp="clr-namespace:WpfToolkit.Controls;assembly=VirtualizingWrapPanel"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=vm:ChampionGridViewModel, IsDesignTimeCreatable=False}"
             d:DesignHeight="600" d:DesignWidth="1000">
    <Grid Background="{StaticResource WindowBackgroundColor}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="15,15,15,10">
            <TextBox Style="{StaticResource TextBoxWithPlaceholder}"
                      Tag="Search Champions..."
                      Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                      MinWidth="250" Margin="0,0,15,0" Height="32"/>

            <TextBlock Text="Role:" Foreground="{StaticResource ForegroundLightGray}" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <ComboBox ItemsSource="{Binding AllRoles}"
                       SelectedItem="{Binding SelectedRole, Mode=TwoWay}"
                       MinWidth="150"
                       VerticalAlignment="Center"
                       Height="32"
                       Style="{StaticResource ComboBoxStyle}"/>
        </StackPanel>

        <ItemsControl Grid.Row="1" ItemsSource="{Binding ChampionsView}"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      ScrollViewer.CanContentScroll="True"
                      HorizontalAlignment="Center" VerticalAlignment="Top" Margin="5,0,5,5">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <vwp:VirtualizingWrapPanel Orientation="Horizontal"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type m:ChampionSummary}">
                    <Button Style="{StaticResource ChampionGridButtonStyle}"
                            Command="{Binding DataContext.SelectChampionCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                            CommandParameter="{Binding}">
                        <StackPanel Orientation="Vertical" Width="90" HorizontalAlignment="Center">
                            <Border Width="80" Height="80" CornerRadius="3" Margin="0,5,0,5" ClipToBounds="True">
                                <Image Source="{Binding ChampionImageSource}" Stretch="Uniform" 
                                       RenderOptions.BitmapScalingMode="HighQuality"/>
                            </Border>
                            <TextBlock Text="{Binding Name}" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Foreground="{StaticResource ForegroundColor}" FontSize="12" 
                                       TextTrimming="CharacterEllipsis" TextAlignment="Center" Margin="0,0,0,5"/>
                        </StackPanel>
                    </Button>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <ProgressBar Grid.Row="1" Style="{StaticResource LoadingProgressBarStyle}"
                      Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}" />
    </Grid>
</UserControl>
/// Views End of ChampionGridView.xaml ///

/// Views Start of OmnisearchDialog.xaml ///
<UserControl x:Class="SkinHunterWPF.Views.OmnisearchDialog"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:vm="clr-namespace:SkinHunterWPF.ViewModels"
             xmlns:m="clr-namespace:SkinHunterWPF.Models"
             xmlns:converters="clr-namespace:SkinHunterWPF.Converters"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance Type=vm:OmnisearchViewModel, IsDesignTimeCreatable=True}"
             Width="600" MaxHeight="700" MinHeight="150" 
             d:DesignHeight="600" d:DesignWidth="600">

    <Border Background="{StaticResource CardBackgroundColor}" CornerRadius="8" BorderBrush="{StaticResource CardBorderColor}" BorderThickness="0.5" Padding="0">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <DockPanel Grid.Row="0" Margin="20,15,15,10" LastChildFill="True">
                <Button DockPanel.Dock="Right" Command="{Binding CloseOmnisearchDialogCommand}" Style="{StaticResource ButtonIconOnlyStyle}" VerticalAlignment="Center" ToolTip="Close" Width="28" Height="28">
                    <Path Data="M0,0 L10,10 M10,0 L0,10" Stroke="{StaticResource ForegroundGray}" StrokeThickness="1.8" Width="10" Height="10"/>
                </Button>
                <TextBlock Text="Search" FontSize="22" FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{StaticResource ForegroundColor}"/>
            </DockPanel>

            <Border Grid.Row="1" Background="{StaticResource HeaderBackgroundColor}" Padding="15,12" Margin="20,5,20,15" CornerRadius="6">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBox Grid.Column="0" Style="{StaticResource TextBoxWithPlaceholder}" Tag="Search..."
                             Text="{Binding Query, UpdateSourceTrigger=PropertyChanged}"
                             Height="40" VerticalContentAlignment="Center" FontSize="16" Padding="35,0,5,0"/>
                             <!-- SECCIÓN <TextBox.Resources> ELIMINADA -->
                    
                    <Path Data="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L21.5,20L20,21.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" 
                          Fill="{StaticResource ForegroundGray}" Width="16" Height="16" Stretch="Uniform"
                          HorizontalAlignment="Left" VerticalAlignment="Center" Margin="10,0,0,0" IsHitTestVisible="False"/>


                    <Popup Placement="Bottom" PlacementTarget="{Binding ElementName=FilterButton}" IsOpen="{Binding IsFilterPopupOpen, Mode=TwoWay}" AllowsTransparency="True" StaysOpen="False">
                        <Border Background="{StaticResource CardBackgroundColor}" BorderBrush="{StaticResource CardBorderColor}" BorderThickness="1" Padding="12" CornerRadius="4" Margin="0,5,0,0">
                            <StackPanel>
                                <CheckBox IsChecked="{Binding ShowChampionsFilter}" Content="Champions" Foreground="{StaticResource ForegroundColor}" Margin="0,0,0,8" Style="{StaticResource ModernCheckBoxStyle}"/>
                                <CheckBox IsChecked="{Binding ShowSkinsFilter}" Content="Skins" Foreground="{StaticResource ForegroundColor}" Style="{StaticResource ModernCheckBoxStyle}"/>
                            </StackPanel>
                        </Border>
                    </Popup>
                    
                    <Button x:Name="FilterButton" Grid.Column="1" Style="{StaticResource ButtonIconOnlyStyle}" Margin="8,0,0,0" Width="40" Height="40"
                            Command="{Binding ToggleFilterPopupCommand}" ToolTip="Filters">
                        <Path Data="M12,16A2,2 0 0,0 14,14A2,2 0 0,0 12,12A2,2 0 0,0 10,14A2,2 0 0,0 12,16M12,10A2,2 0 0,0 14,8A2,2 0 0,0 12,6A2,2 0 0,0 10,8A2,2 0 0,0 12,10M12,4A2,2 0 0,0 14,2A2,2 0 0,0 12,0A2,2 0 0,0 10,2A2,2 0 0,0 12,4Z" 
                              Fill="{StaticResource ForegroundGray}" Width="4" Height="16" Stretch="Uniform"/>
                    </Button>
                </Grid>
            </Border>
            
            <Grid Grid.Row="2" Margin="20,0,20,20">
                <ProgressBar Style="{StaticResource LoadingProgressBarStyle}" 
                             Visibility="{Binding IsLoadingSearchResults, Converter={StaticResource BooleanToVisibilityConverter}}"
                             Width="35" Height="35" VerticalAlignment="Center" HorizontalAlignment="Center"/>

                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" 
                              Visibility="{Binding IsLoadingSearchResults, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                    <ItemsControl ItemsSource="{Binding SearchResultsView}">
                        <ItemsControl.GroupStyle>
                            <GroupStyle>
                                <GroupStyle.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" Foreground="{StaticResource ForegroundLightGray}" FontSize="13" FontWeight="SemiBold" Margin="0,10,0,5"/>
                                    </DataTemplate>
                                </GroupStyle.HeaderTemplate>
                            </GroupStyle>
                        </ItemsControl.GroupStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type m:SearchResultItem}">
                                <Button Command="{Binding DataContext.SelectResultCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                                        CommandParameter="{Binding}"
                                        Style="{StaticResource ButtonTransparentStyle}" HorizontalContentAlignment="Stretch" Margin="0,3">
                                    <Border Background="{StaticResource HeaderBackgroundColor}" Padding="10" CornerRadius="4"
                                            BorderThickness="1" BorderBrush="Transparent">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <Border Grid.Column="0" Width="54" Height="54" CornerRadius="3" Margin="0,0,12,0" Background="#222226">
                                                <Grid>
                                                    <Border Background="#303035" Visibility="{Binding ImageSource, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=True, FallbackValue=Visible}"/>
                                                    <Image Source="{Binding ImageSource}" Stretch="Uniform" RenderOptions.BitmapScalingMode="Fant">
                                                        <Image.Style>
                                                            <Style TargetType="Image">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding ImageSource}" Value="{x:Null}"/>
                                                                    <DataTrigger Binding="{Binding ImageSource, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=False}" Value="Visible">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Image.Style>
                                                    </Image>
                                                </Grid>
                                            </Border>
                                            
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Name}" Foreground="{StaticResource ForegroundColor}" FontSize="15" FontWeight="Medium" TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding DisplayType}" Foreground="{StaticResource ForegroundGray}" FontSize="12"/>
                                            </StackPanel>
                                        </Grid>
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Effect" Value="{x:Null}"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                                         <Setter Property="Background" Value="{StaticResource ButtonHoverBrush}"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                    </Border>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Border>
</UserControl>
/// Views End of OmnisearchDialog.xaml ///

/// Views Start of SkinDetailDialog.xaml ///
<UserControl x:Class="SkinHunterWPF.Views.SkinDetailDialog"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:SkinHunterWPF.ViewModels"
             xmlns:m="clr-namespace:SkinHunterWPF.Models"
             xmlns:converters="clr-namespace:SkinHunterWPF.Converters"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=vm:SkinDetailViewModel, IsDesignTimeCreatable=False}"
             Width="850" MaxHeight="650" d:DesignWidth="850">

    <UserControl.Resources>
        <DataTemplate x:Key="ChromaCircleTemplate" DataType="{x:Type m:Chroma}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <Ellipse Width="50" Height="50" Stroke="{StaticResource ForegroundGray}" StrokeThickness="1" Fill="{Binding ColorBrush}" Margin="0,5,0,5"/>
                <TextBlock Text="{Binding Name}" HorizontalAlignment="Center" FontSize="11" TextTrimming="CharacterEllipsis" Margin="0,0,0,5" MaxWidth="75" TextAlignment="Center" TextWrapping="Wrap"/>
            </StackPanel>
        </DataTemplate>
        <DataTemplate x:Key="ChromaImageTemplate" DataType="{x:Type m:Chroma}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <Image Source="{Binding ImageUrl}" Width="60" Height="60" Stretch="Uniform" Margin="0,5,0,5" RenderOptions.BitmapScalingMode="HighQuality"/>
                <TextBlock Text="{Binding Name}" HorizontalAlignment="Center" FontSize="11" TextTrimming="CharacterEllipsis" Margin="0,0,0,5" MaxWidth="75" TextAlignment="Center" TextWrapping="Wrap"/>
            </StackPanel>
        </DataTemplate>
        <Style x:Key="RadioButtonCardStyle" TargetType="RadioButton">
            <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
            <Setter Property="Background" Value="{StaticResource CardBackgroundColor}"/>
            <Setter Property="BorderBrush" Value="{StaticResource CardBorderColor}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Margin" Value="4"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Width" Value="95"/>
            <Setter Property="Height" Value="105"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4">
                            <ContentPresenter Margin="{TemplateBinding Padding}" HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource ButtonHoverBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <converters:ChromaToButtonTextConverter x:Key="ChromaToButtonTextConverter"/>
    </UserControl.Resources>

    <Border Background="#1F1F1F" CornerRadius="5" BorderBrush="{StaticResource CardBorderColor}" BorderThickness="1">
        <Grid Margin="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <DockPanel Grid.Row="0" Grid.ColumnSpan="2" Margin="0,0,0,15" LastChildFill="False">
                <Button DockPanel.Dock="Right" Command="{Binding CloseDialogCommand}" Style="{StaticResource ButtonIconOnlyStyle}" ToolTip="Close">
                    <Path Data="M0,0 L10,10 M10,0 L0,10" Stroke="{StaticResource ForegroundGray}" StrokeThickness="1.5" Width="10" Height="10"/>
                </Button>
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal">
                    <Image Source="{Binding SelectedSkin.RarityImageUrl}" Width="20" Height="20" Margin="0,0,8,0" VerticalAlignment="Center"
                           Visibility="{Binding SelectedSkin.RarityImageUrl, Converter={StaticResource NullToVisibilityConverter}}"/>
                    <TextBlock Text="{Binding SelectedSkin.Name}" Foreground="{StaticResource ForegroundColor}" FontSize="20" FontWeight="Bold" VerticalAlignment="Center"/>
                </StackPanel>
            </DockPanel>

            <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,25,0" MaxWidth="400">
                <Border Style="{StaticResource CardBorderStyle}" Padding="0">
                    <Grid>
                        <Image Source="{Binding SelectedSkin.SplashImageUrl}" Height="240" Stretch="UniformToFill" VerticalAlignment="Top"/>
                    </Grid>
                </Border>
                <ScrollViewer MaxHeight="150" VerticalScrollBarVisibility="Auto" Margin="0,15,0,0">
                    <TextBlock Text="{Binding SelectedSkin.Description, FallbackValue='This skin does not have a description.'}"
                               Foreground="{StaticResource ForegroundLightGray}" FontSize="13" TextWrapping="Wrap"/>
                </ScrollViewer>
                <Border Background="#44FFFF00" BorderBrush="#FFFFCC00" BorderThickness="1" CornerRadius="3" Padding="8,5" Margin="0,15,0,0">
                    <TextBlock Text="This skin may not work properly due to game updates" FontSize="11" Foreground="#FFFFEEAA"/>
                </Border>
            </StackPanel>

            <DockPanel Grid.Row="1" Grid.Column="1">
                <StackPanel DockPanel.Dock="Top">
                    <TextBlock Margin="0,0,0,10" Foreground="{StaticResource ForegroundLightGray}">
                        <Run Text="View skin on "/>
                        <Hyperlink NavigateUri="{Binding KhadaViewerUrl}" RequestNavigate="Hyperlink_RequestNavigate" Foreground="#FF77AADD">
                            <Run Text="Model viewer"/>
                        </Hyperlink>
                    </TextBlock>

                    <!-- <TextBlock Margin="0,0,0,10" Foreground="DodgerBlue" Text="ℹ" ToolTip="Preview the in-game appearance of the skin."/>!-->
                </StackPanel>
                <Separator DockPanel.Dock="Top" Margin="0,0,0,15" Background="{StaticResource CardBorderColor}"/>

                <Border DockPanel.Dock="Bottom" Margin="0,15,0,0" Background="#4417A2B8" BorderBrush="#FF17A2B8" BorderThickness="1" Padding="8,5" CornerRadius="3">
                    <TextBlock FontSize="12" Foreground="#FFA6D9E2">
                         <Run Text="This is going to consume a credit"/>
                         <Run Text="{Binding UserCredits, StringFormat='({0} credits left)'}" Foreground="LightGreen"/>
                    </TextBlock>
                </Border>

                <StackPanel Orientation="Vertical">
                    <TextBlock Text="Chromas" Foreground="{StaticResource ForegroundColor}" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8"/>
                    <TabControl Padding="0" Margin="0,0,0,0">
                        <TabItem Header="Circles">
                            <StackPanel Orientation="Vertical">
                                <TextBlock Text="Select a variation to download." Foreground="{StaticResource ForegroundLightGray}" FontSize="12" Margin="0,8,0,8" FontStyle="Italic"/>
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="260" Padding="5,0,5,0" HorizontalScrollBarVisibility="Disabled">
                                    <ItemsControl ItemsSource="{Binding AvailableChromas}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal" ItemWidth="95" ItemHeight="105"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="{x:Type m:Chroma}">
                                                <RadioButton GroupName="ChromaSelectionCircles" Style="{StaticResource RadioButtonCardStyle}"
                                                             IsChecked="{Binding IsSelected, Mode=OneWay}"
                                                             Command="{Binding DataContext.ToggleChromaSelectionCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                                                             CommandParameter="{Binding}">
                                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                        <Ellipse Width="50" Height="50" Stroke="{StaticResource ForegroundGray}" StrokeThickness="1" Fill="{Binding ColorBrush}" Margin="0,5,0,5"/>
                                                        <TextBlock Text="{Binding Name}" HorizontalAlignment="Center" FontSize="11" TextTrimming="CharacterEllipsis" Margin="0,0,0,5" MaxWidth="75" TextAlignment="Center" TextWrapping="Wrap"/>
                                                    </StackPanel>
                                                </RadioButton>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </StackPanel>
                        </TabItem>
                        <TabItem Header="Images">
                            <StackPanel Orientation="Vertical">
                                <TextBlock Text="Select a variation to download." Foreground="{StaticResource ForegroundLightGray}" FontSize="12" Margin="0,8,0,8" FontStyle="Italic"/>
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="260" Padding="5,0,5,0" HorizontalScrollBarVisibility="Disabled">
                                    <ItemsControl ItemsSource="{Binding AvailableChromas}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal" ItemWidth="95" ItemHeight="105"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="{x:Type m:Chroma}">
                                                <RadioButton GroupName="ChromaSelectionImages" Style="{StaticResource RadioButtonCardStyle}"
                                                             IsChecked="{Binding IsSelected, Mode=OneWay}"
                                                             Command="{Binding DataContext.ToggleChromaSelectionCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                                                             CommandParameter="{Binding}">
                                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                        <Image Source="{Binding ImageUrl}" Width="60" Height="60" Stretch="Uniform" Margin="0,5,0,5" RenderOptions.BitmapScalingMode="HighQuality"/>
                                                        <TextBlock Text="{Binding Name}" HorizontalAlignment="Center" FontSize="11" TextTrimming="CharacterEllipsis" Margin="0,0,0,5" MaxWidth="75" TextAlignment="Center" TextWrapping="Wrap"/>
                                                    </StackPanel>
                                                </RadioButton>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </StackPanel>
                        </TabItem>
                    </TabControl>
                </StackPanel>
            </DockPanel>

            <Grid Grid.Row="2" Grid.ColumnSpan="2" Margin="0,20,0,0">
                <Button Content="Close" HorizontalAlignment="Left" Width="90"
                        Command="{Binding CloseDialogCommand}"/>
                <Button Content="{Binding SelectedChroma, Converter={StaticResource ChromaToButtonTextConverter}, FallbackValue='Download Skin'}"
                         Style="{StaticResource ButtonPrimaryStyle}" HorizontalAlignment="Right" Width="150"
                         Command="{Binding DownloadSkinCommand}"
                         IsEnabled="{Binding CanDownload}">
                    <Button.ContentTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Path Data="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" Fill="White" Width="14" Height="14" Stretch="Uniform" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </DataTemplate>
                    </Button.ContentTemplate>
                </Button>
            </Grid>

            <ProgressBar Grid.Row="0" Grid.RowSpan="3" Grid.ColumnSpan="2" Style="{StaticResource LoadingProgressBarStyle}"
                          Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}" />

        </Grid>
    </Border>
</UserControl>
/// Views End of SkinDetailDialog.xaml ///

/// ViewModels Start of BaseViewModel.cs ///
﻿using CommunityToolkit.Mvvm.ComponentModel;

namespace SkinHunterWPF.ViewModels
{
    public abstract partial class BaseViewModel : ObservableObject
    {
        [ObservableProperty]
        [NotifyPropertyChangedFor(nameof(IsNotLoading))]
        private bool _isLoading;

        public bool IsNotLoading => !IsLoading;
    }
}
/// ViewModels End of BaseViewModel.cs ///

/// ViewModels Start of ChampionDetailViewModel.cs ///
﻿using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SkinHunterWPF.Models;
using SkinHunterWPF.Services; // Asegúrate que este using está presente
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using System.Linq;
using System.Windows;
using System;
using System.Diagnostics;

namespace SkinHunterWPF.ViewModels
{
    public partial class ChampionDetailViewModel : BaseViewModel
    {
        private readonly INavigationService _navigationService;

        [ObservableProperty]
        private ChampionDetail? _champion;

        [ObservableProperty]
        private ObservableCollection<Skin> _skins = [];

        public ChampionDetailViewModel(INavigationService navigationService)
        {
            _navigationService = navigationService;
        }

        public void ReleaseResourcesForTray()
        {
            Debug.WriteLine($"[ChampionDetailViewModel] Liberando recursos para la bandeja (Campeón: {Champion?.Name}).");
            IsLoading = true;
            Champion?.ReleaseImage();
            Champion = null;
            Skins.Clear();
            IsLoading = false;
            Debug.WriteLine("[ChampionDetailViewModel] Recursos liberados.");
        }

        public void PrepareForReload()
        {
            Debug.WriteLine($"[ChampionDetailViewModel] Preparando para recarga (Campeón anterior: {Champion?.Name}).");
            IsLoading = true;
            Champion?.ReleaseImage();
            Champion = null;
            Skins.Clear();
        }

        [RelayCommand]
        public async Task LoadChampionAsync(int championId)
        {
            if (Champion?.Id == championId && Skins.Any())
            {
                Debug.WriteLine($"[ChampionDetailViewModel] Campeón {championId} ya cargado con {Skins.Count} skins. Omitiendo recarga.");
                IsLoading = false;
                return;
            }

            Debug.WriteLine($"[ChampionDetailViewModel] LoadChampionAsync para ID: {championId}");
            IsLoading = true;

            // Limpiar si es un campeón diferente O si las skins están vacías (ej. después de ReleaseResources)
            if (Champion?.Id != championId || !Skins.Any())
            {
                Skins.Clear();
                Champion?.ReleaseImage();
                Champion = null;
            }


            var details = await CdragonDataService.GetChampionDetailsAsync(championId);

            if (details != null)
            {
                Champion = details;

                if (details.Skins != null && details.Skins.Any())
                {
                    foreach (var skin in details.Skins.Where(s =>
                                !s.Name.Equals(details.Name, StringComparison.OrdinalIgnoreCase) &&
                                !s.Name.Equals($"Base {details.Name}", StringComparison.OrdinalIgnoreCase) &&
                                !s.Name.Contains("Original", StringComparison.OrdinalIgnoreCase)))
                    {
                        Skins.Add(skin);
                    }
                    Debug.WriteLine($"[ChampionDetailViewModel] Cargadas {Skins.Count} skins para {Champion.Name}.");
                }
                else
                {
                    Debug.WriteLine($"[ChampionDetailViewModel] No se encontraron skins (o lista vacía) para {Champion?.Name}.");
                }
            }
            else
            {
                System.Windows.MessageBox.Show($"Failed to load details for Champion ID: {championId}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
            }
            IsLoading = false;
            Debug.WriteLine($"[ChampionDetailViewModel] LoadChampionAsync para ID: {championId} FINALIZADO. IsLoading={IsLoading}");
        }

        [RelayCommand]
        private void SelectSkin(Skin? skin)
        {
            if (skin != null)
            {
                _navigationService.ShowDialog<SkinDetailViewModel>(skin);
            }
        }

        [RelayCommand]
        private void GoBack()
        {
            _navigationService.GoBack();
        }
    }
}
/// ViewModels End of ChampionDetailViewModel.cs ///

/// ViewModels Start of ChampionGridViewModel.cs ///
﻿using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SkinHunterWPF.Models;
using SkinHunterWPF.Services; // Asegúrate que este using está presente
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Data;
using System.ComponentModel;
using System;
using System.Windows;
using System.Collections.Generic;
using System.Diagnostics;
using System.Windows.Threading;
using System.Windows.Media.Imaging;

namespace SkinHunterWPF.ViewModels
{
    public partial class ChampionGridViewModel : BaseViewModel
    {
        private readonly INavigationService _navigationService;
        private readonly ObservableCollection<ChampionSummary> _allChampions = new();

        [ObservableProperty]
        private string? _searchText;

        [ObservableProperty]
        private ObservableCollection<string> _allRoles = new();

        [ObservableProperty]
        private string? _selectedRole = "All";

        public ICollectionView ChampionsView { get; }

        public ChampionGridViewModel(INavigationService navigationService)
        {
            _navigationService = navigationService;
            ChampionsView = CollectionViewSource.GetDefaultView(_allChampions);
            ChampionsView.Filter = FilterChampions;
            AllRoles.Add("All");
        }

        public void ReleaseResourcesForTray()
        {
            Debug.WriteLine("[ChampionGridViewModel] Liberando recursos para la bandeja...");
            IsLoading = true;
            if (_allChampions.Any())
            {
                var championsToRelease = _allChampions.ToList();
                System.Windows.Application.Current?.Dispatcher.Invoke(() => _allChampions.Clear());

                foreach (var champ in championsToRelease)
                {
                    champ.ReleaseImage();
                }

                System.Windows.Application.Current?.Dispatcher.Invoke(() => ChampionsView?.Refresh());
                Debug.WriteLine($"[ChampionGridViewModel] Colección _allChampions limpiada. Count: {_allChampions.Count}");
            }
            else
            {
                Debug.WriteLine("[ChampionGridViewModel] _allChampions ya estaba vacía.");
            }
            IsLoading = false;
            Debug.WriteLine("[ChampionGridViewModel] Recursos liberados.");
        }


        partial void OnSearchTextChanged(string? value)
        {
            System.Windows.Application.Current?.Dispatcher.InvokeAsync(() => ChampionsView.Refresh(), DispatcherPriority.Background);
        }

        partial void OnSelectedRoleChanged(string? value)
        {
            Debug.WriteLine($"[ChampionGridViewModel] Selected Role Changed: {value}");
            System.Windows.Application.Current?.Dispatcher.InvokeAsync(() => ChampionsView.Refresh(), DispatcherPriority.Background);
        }

        private bool FilterChampions(object item)
        {
            if (!(item is ChampionSummary champ)) return false;

            bool textMatch = string.IsNullOrWhiteSpace(SearchText) ||
                             champ.Name.Contains(SearchText, StringComparison.OrdinalIgnoreCase);

            bool roleMatch = string.IsNullOrEmpty(SelectedRole) ||
                             SelectedRole.Equals("All", StringComparison.OrdinalIgnoreCase) ||
                             (champ.Roles != null && champ.Roles.Any(r => r.Equals(SelectedRole, StringComparison.OrdinalIgnoreCase)));

            return textMatch && roleMatch;
        }

        private void PopulateRoles()
        {
            var uniqueRoles = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            if (_allChampions.Any())
            {
                foreach (var champ in _allChampions)
                {
                    if (champ.Roles != null)
                    {
                        foreach (var role in champ.Roles)
                        {
                            if (!string.IsNullOrWhiteSpace(role))
                            {
                                uniqueRoles.Add(role);
                            }
                        }
                    }
                }
            }

            var sortedRoles = uniqueRoles.OrderBy(r => r).ToList();
            string? currentSelection = SelectedRole;

            System.Windows.Application.Current?.Dispatcher.Invoke(() => {
                string? actualCurrentSelection = SelectedRole;
                AllRoles.Clear();
                AllRoles.Add("All");
                foreach (var role in sortedRoles)
                {
                    string displayRole = role.Length > 0 ? char.ToUpper(role[0]) + role.Substring(1) : role;
                    AllRoles.Add(displayRole);
                }

                if (!string.IsNullOrEmpty(actualCurrentSelection) && AllRoles.Contains(actualCurrentSelection))
                {
                    if (SelectedRole != actualCurrentSelection) SelectedRole = actualCurrentSelection;
                }
                else
                {
                    if (SelectedRole != "All") SelectedRole = "All";
                }
            });
        }

        [RelayCommand]
        public async Task LoadChampionsAsync()
        {
            if (IsLoading && _allChampions.Any())
            {
                Debug.WriteLine("[ChampionGridViewModel] LoadChampionsAsync llamado pero ya está cargando con datos, retornando.");
                return;
            }

            IsLoading = true;
            Debug.WriteLine("[ChampionGridViewModel] LoadChampionsAsync INICIADO.");

            if (_allChampions.Any()) // Limpiar si ya hay datos, para asegurar que una recarga sea fresca
            {
                var championsToRelease = _allChampions.ToList();
                System.Windows.Application.Current?.Dispatcher.Invoke(() => _allChampions.Clear());
                foreach (var champ in championsToRelease)
                {
                    champ.ReleaseImage();
                }
                Debug.WriteLine("[ChampionGridViewModel] _allChampions limpiada antes de cargar nuevos datos.");
            }


            var champs = await CdragonDataService.GetChampionSummariesAsync();
            if (champs != null)
            {
                foreach (var champ in champs.OrderBy(c => c.Name))
                {
                    if (champ.Roles == null) champ.Roles = new List<string>();
                    System.Windows.Application.Current?.Dispatcher.Invoke(() => _allChampions.Add(champ));
                }
                Debug.WriteLine($"[ChampionGridViewModel] Added {_allChampions.Count} champions to collection.");

                PopulateRoles();
                System.Windows.Application.Current?.Dispatcher.Invoke(() => ChampionsView.Refresh());
                Debug.WriteLine("[ChampionGridViewModel] Roles populated and ChampionsView refreshed.");
            }
            else
            {
                Debug.WriteLine("[ChampionGridViewModel] Failed to load champions from service.");
                System.Windows.Application.Current?.Dispatcher.Invoke(() => {
                    System.Windows.MessageBox.Show("Failed to load champions.", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                });
            }

            IsLoading = false;
            Debug.WriteLine("[ChampionGridViewModel] LoadChampionsAsync FINALIZADO.");
        }

        [RelayCommand]
        private void SelectChampion(ChampionSummary? champion)
        {
            if (champion != null)
            {
                _navigationService.NavigateTo<ChampionDetailViewModel>(champion.Id);
            }
        }
    }
}
/// ViewModels End of ChampionGridViewModel.cs ///

/// ViewModels Start of MainViewModel.cs ///
﻿using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SkinHunterWPF.Services;
using System.Threading.Tasks;
using System.Linq;
using System.Windows;
using Microsoft.Extensions.DependencyInjection;
using System;
using System.Diagnostics;


namespace SkinHunterWPF.ViewModels
{
    public partial class MainViewModel(INavigationService navigationService, ChampionGridViewModel championGridVM, IServiceProvider serviceProvider) : BaseViewModel
    {
        private readonly INavigationService _navigationService = navigationService;
        private readonly IServiceProvider _serviceProvider = serviceProvider;

        [ObservableProperty]
        private BaseViewModel? _currentViewModel = championGridVM;

        [ObservableProperty]
        private BaseViewModel? _dialogViewModel;

        [ObservableProperty]
        private OmnisearchViewModel? _omnisearchDialogViewModel;


        public async Task EnsureInitialDataLoadedAsync()
        {
            if (CurrentViewModel is ChampionGridViewModel cgvm)
            {
                if (cgvm.ChampionsView == null || !cgvm.ChampionsView.Cast<object>().Any())
                {
                    if (cgvm.LoadChampionsCommand.CanExecute(null))
                        await cgvm.LoadChampionsCommand.ExecuteAsync(null);
                }
            }
        }


        [RelayCommand]
        private void CloseDialog()
        {
            DialogViewModel = null;
        }

        // Usar [RelayCommand], el generador crea la versión Async si el método devuelve Task
        [RelayCommand]
        private async Task OpenOmnisearchDialogAsync()
        {
            if (OmnisearchDialogViewModel == null)
            {
                Debug.WriteLine("[MainViewModel] Creando instancia de OmnisearchViewModel.");
                OmnisearchDialogViewModel = _serviceProvider.GetRequiredService<OmnisearchViewModel>();
            }
            Debug.WriteLine("[MainViewModel] Asegurando datos para OmnisearchViewModel.");
            if (OmnisearchDialogViewModel != null)
            {
                await OmnisearchDialogViewModel.EnsureDataLoadedAsync();
            }
            Debug.WriteLine("[MainViewModel] OmnisearchDialogViewModel listo para mostrarse.");
        }


        [RelayCommand]
        private void NavigateToChampions()
        {
            if (DialogViewModel == null && OmnisearchDialogViewModel == null)
            {
                _navigationService.NavigateTo<ChampionGridViewModel>();
            }
        }

        [RelayCommand]
        private void NavigateToInstalled()
        {
            if (DialogViewModel == null && OmnisearchDialogViewModel == null)
                System.Windows.MessageBox.Show("Installed View Not Implemented Yet.");
        }

        // El comando generado para este método será OpenSearchCommand
        [RelayCommand]
        private async Task OpenSearchAsync()
        {
            if (DialogViewModel == null)
            {
                // El comando generado para OpenOmnisearchDialogAsync será OpenOmnisearchDialogCommand
                if (OpenOmnisearchDialogCommand != null && OpenOmnisearchDialogCommand.CanExecute(null))
                {
                    await OpenOmnisearchDialogCommand.ExecuteAsync(null);
                }
            }
        }

        [RelayCommand]
        private void OpenProfile()
        {
            if (DialogViewModel == null && OmnisearchDialogViewModel == null)
                System.Windows.MessageBox.Show("Profile View Not Implemented Yet.");
        }
    }
}
/// ViewModels End of MainViewModel.cs ///

/// ViewModels Start of OmnisearchViewModel.cs ///
﻿using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SkinHunterWPF.Models;
using SkinHunterWPF.Services;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Data;
using System.ComponentModel;
using System.Diagnostics;
using System.Threading;
using Microsoft.Extensions.DependencyInjection;


namespace SkinHunterWPF.ViewModels
{
    public partial class OmnisearchViewModel : BaseViewModel
    {
        private readonly INavigationService? _navigationService;
        private readonly IServiceProvider? _serviceProvider;
        private List<ChampionSummary> _allChampionsMasterList = [];
        private List<Skin> _allSkinsMasterList = [];
        private Dictionary<int, ChampionSummary> _championMap = [];

        [ObservableProperty]
        private string? _query;

        [ObservableProperty]
        private bool _showChampionsFilter = true;

        [ObservableProperty]
        private bool _showSkinsFilter = true;

        [ObservableProperty]
        private bool _isFilterPopupOpen;

        [ObservableProperty]
        private bool _isLoadingSearchResults;

        public ObservableCollection<SearchResultItem> SearchResults { get; } = [];
        public ICollectionView SearchResultsView { get; }

        public OmnisearchViewModel()
        {
            if (DesignerProperties.GetIsInDesignMode(new System.Windows.DependencyObject()))
            {
                Query = "Search...";
                SearchResults.Add(new SearchResultItem(new ChampionSummary { Id = 1, Name = "Design Champion", SquarePortraitPath = "" }));
                SearchResults.Add(new SearchResultItem(new Skin { Id = 1001, Name = "Design Skin", TilePath = "", ChampionId = 1 }, new ChampionSummary { Id = 1, Name = "Parent" }));
            }
            _navigationService = null;
            _serviceProvider = null;
            SearchResultsView = CollectionViewSource.GetDefaultView(SearchResults);
            if (SearchResultsView.GroupDescriptions != null)
            {
                SearchResultsView.GroupDescriptions.Add(new PropertyGroupDescription("DisplayType"));
            }
        }

        public OmnisearchViewModel(INavigationService navigationService, IServiceProvider serviceProvider)
        {
            _navigationService = navigationService ?? throw new ArgumentNullException(nameof(navigationService));
            _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
            SearchResultsView = CollectionViewSource.GetDefaultView(SearchResults);
            if (SearchResultsView.GroupDescriptions != null)
            {
                SearchResultsView.GroupDescriptions.Add(new PropertyGroupDescription("DisplayType"));
            }
        }

        private bool _isDataLoaded = false;

        public async Task EnsureDataLoadedAsync()
        {
            if (_isDataLoaded) return;
            if (_serviceProvider == null) return;

            IsLoading = true;
            try
            {
                var champsTask = CdragonDataService.GetChampionSummariesAsync();
                var skinsTask = CdragonDataService.GetAllSkinsAsync();
                await Task.WhenAll(champsTask, skinsTask);

                var champs = await champsTask;
                if (champs != null)
                {
                    _allChampionsMasterList = champs;
                    _championMap = champs.ToDictionary(c => c.Id);
                }

                var skinsDict = await skinsTask;
                if (skinsDict != null)
                {
                    _allSkinsMasterList = skinsDict.Values
                        .Where(s => {
                            bool isBaseSkinName = false;
                            if (_championMap.TryGetValue(s.ChampionId, out var parentChamp))
                            {
                                isBaseSkinName = s.Name.Equals(parentChamp.Name, StringComparison.OrdinalIgnoreCase) ||
                                                 s.Name.Equals($"Base {parentChamp.Name}", StringComparison.OrdinalIgnoreCase);
                            }
                            return !isBaseSkinName && !s.Name.Contains("Original", StringComparison.OrdinalIgnoreCase);
                        })
                        .OrderBy(s => s.Name)
                        .ToList();
                }
                _isDataLoaded = true;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"[OmnisearchViewModel] Error cargando datos maestros: {ex.Message}");
            }
            finally
            {
                IsLoading = false;
            }
        }

        partial void OnQueryChanged(string? value)
        {
            PerformSearch();
        }

        partial void OnShowChampionsFilterChanged(bool value)
        {
            PerformSearch();
        }

        partial void OnShowSkinsFilterChanged(bool value)
        {
            PerformSearch();
        }

        private CancellationTokenSource _searchCts = new();

        private async void PerformSearch()
        {
            if (!_isDataLoaded && _serviceProvider != null)
            {
                await EnsureDataLoadedAsync();
                if (!_isDataLoaded)
                {
                    SearchResults.Clear();
                    return;
                }
            }
            else if (!_isDataLoaded && _serviceProvider == null)
            {
                return;
            }

            _searchCts.Cancel();
            _searchCts = new CancellationTokenSource();
            var token = _searchCts.Token;
            var currentQuery = Query;

            SearchResults.Clear();

            if (string.IsNullOrWhiteSpace(currentQuery) || currentQuery.Length < 1)
            {
                IsLoadingSearchResults = false;
                return;
            }

            IsLoadingSearchResults = true;

            try
            {
                await Task.Run(async () => {
                    if (token.IsCancellationRequested) return;
                    List<SearchResultItem> newResults = [];
                    if (ShowChampionsFilter)
                    {
                        newResults.AddRange(_allChampionsMasterList
                            .Where(c => c.Name.Contains(currentQuery, StringComparison.OrdinalIgnoreCase))
                            .Select(c => new SearchResultItem(c)));
                    }
                    if (ShowSkinsFilter)
                    {
                        newResults.AddRange(_allSkinsMasterList
                            .Where(s => s.Name.Contains(currentQuery, StringComparison.OrdinalIgnoreCase))
                            .Select(s => new SearchResultItem(s, _championMap.TryGetValue(s.ChampionId, out var champ) ? champ : null)));
                    }
                    if (token.IsCancellationRequested) return;
                    var orderedResults = newResults.OrderBy(r => r.Type).ThenBy(r => r.Name).Take(25).ToList();
                    if (token.IsCancellationRequested) return;

                    System.Windows.Application.Current.Dispatcher.Invoke(() =>
                    {
                        if (!token.IsCancellationRequested)
                        {
                            foreach (var item in orderedResults)
                            {
                                SearchResults.Add(item);
                                _ = item.LoadImageAsync();
                            }
                        }
                    });
                }, token);
            }
            catch (TaskCanceledException) { Debug.WriteLine("[OmnisearchViewModel] Búsqueda (Task.Run) cancelada."); }
            catch (Exception ex) { Debug.WriteLine($"[OmnisearchViewModel] Error durante la búsqueda: {ex.Message}"); }
            finally
            {
                if (!token.IsCancellationRequested)
                {
                    IsLoadingSearchResults = false;
                }
            }
        }

        [RelayCommand]
        private void SelectResult(SearchResultItem? selectedItem)
        {
            if (selectedItem == null || _navigationService == null) return;
            CloseOmnisearchDialog();
            if (selectedItem.Type == SearchResultType.Champion)
            {
                _navigationService.NavigateTo<ChampionDetailViewModel>(selectedItem.ChampionId);
            }
            else if (selectedItem.Type == SearchResultType.Skin && selectedItem.OriginalSkinObject != null)
            {
                _navigationService.ShowDialog<SkinDetailViewModel>(selectedItem.OriginalSkinObject);
            }
        }

        [RelayCommand]
        private void CloseOmnisearchDialog()
        {
            IsFilterPopupOpen = false;
            if (_serviceProvider == null) return;
            var mainViewModel = _serviceProvider.GetRequiredService<MainViewModel>();
            if (mainViewModel?.OmnisearchDialogViewModel == this)
            {
                mainViewModel.OmnisearchDialogViewModel = null;
            }
        }

        [RelayCommand]
        private void ToggleFilterPopup()
        {
            IsFilterPopupOpen = !IsFilterPopupOpen;
        }
    }
}
/// ViewModels End of OmnisearchViewModel.cs ///

/// ViewModels Start of SkinDetailViewModel.cs ///
﻿using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SkinHunterWPF.Models;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System;
using Microsoft.Extensions.DependencyInjection;
using System.Windows; // Se mantiene para MessageBoxButton, MessageBoxImage
using System.Diagnostics;

namespace SkinHunterWPF.ViewModels
{
    public partial class SkinDetailViewModel : BaseViewModel
    {
        private readonly IServiceProvider _serviceProvider;

        [ObservableProperty]
        private Skin? _selectedSkin;

        [ObservableProperty]
        private ObservableCollection<Chroma> _availableChromas = new();

        [ObservableProperty]
        [NotifyPropertyChangedFor(nameof(IsDefaultSelected))]
        [NotifyPropertyChangedFor(nameof(KhadaViewerUrl))]
        private Chroma? _selectedChroma;

        [ObservableProperty]
        private int _userCredits = 5;

        public bool IsDefaultSelected => SelectedChroma == null;

        public string? KhadaViewerUrl
        {
            get
            {
                if (SelectedSkin == null) return null;
                int skinId = SelectedSkin.Id;
                int? chromaId = SelectedChroma?.Id;
                string url = $"https://modelviewer.lol/model-viewer?id={skinId}";
                if (chromaId.HasValue && chromaId.Value != 0 && chromaId.Value / 1000 == skinId)
                {
                    url += $"&chroma={chromaId.Value}";
                }
                return url;
            }
        }

        public SkinDetailViewModel(IServiceProvider serviceProvider)
        {
            _serviceProvider = serviceProvider;
            Debug.WriteLine("[SkinDetailViewModel] Constructor called.");
        }

        public void LoadSkin(Skin skin)
        {
            Debug.WriteLine($"[SkinDetailViewModel] LoadSkin called for Skin ID: {skin.Id} ('{skin.Name}')");
            SelectedSkin = skin;
            AvailableChromas.Clear();
            Debug.WriteLine($"[SkinDetailViewModel] AvailableChromas cleared.");

            if (skin.Chromas != null && skin.Chromas.Any())
            {
                Debug.WriteLine($"[SkinDetailViewModel] Skin has {skin.Chromas.Count} chromas to process.");
                foreach (var chroma in skin.Chromas)
                {
                    if (chroma != null)
                    {
                        chroma.IsSelected = false;
                        AvailableChromas.Add(chroma);
                        Debug.WriteLine($"[SkinDetailViewModel] Added Chroma ID: {chroma.Id}, Name: '{chroma.Name}' to AvailableChromas.");
                    }
                }
                Debug.WriteLine($"[SkinDetailViewModel] Finished processing chromas. Final AvailableChromas count: {AvailableChromas.Count}");
            }
            else
            {
                Debug.WriteLine($"[SkinDetailViewModel] Skin ID: {skin.Id} has no chromas.");
            }

            SelectedChroma = null;
            DownloadSkinCommand.NotifyCanExecuteChanged();
            RefreshChromaSelections(null);
        }

        public bool CanDownload()
        {
            return UserCredits > 0;
        }

        [RelayCommand(CanExecute = nameof(CanDownload))]
        private async Task DownloadSkinAsync()
        {
            IsLoading = true;
            var skinOrChromaName = IsDefaultSelected ? SelectedSkin?.Name : SelectedChroma?.Name;
            var idToDownload = IsDefaultSelected ? SelectedSkin?.Id : SelectedChroma?.Id;
            Debug.WriteLine($"[SkinDetailViewModel] DownloadSkinAsync: Downloading '{skinOrChromaName}' (ID: {idToDownload})");

            await Task.Delay(1500);

            UserCredits--;
            DownloadSkinCommand.NotifyCanExecuteChanged();

            IsLoading = false;
            System.Windows.MessageBox.Show($"'{skinOrChromaName}' (ID: {idToDownload}) download initiated!", "Download", MessageBoxButton.OK, MessageBoxImage.Information); // Calificado aquí

            CloseDialog();
        }


        [RelayCommand]
        private void CloseDialog()
        {
            Debug.WriteLine("[SkinDetailViewModel] CloseDialog called.");
            var mainViewModel = _serviceProvider.GetService<MainViewModel>();
            mainViewModel?.CloseDialogCommand.Execute(null);
        }

        private void SetDefaultSelection()
        {
            if (SelectedChroma != null)
            {
                SelectedChroma.IsSelected = false;
            }
            SelectedChroma = null;
            RefreshChromaSelections(null);
        }

        [RelayCommand]
        private void ToggleChromaSelection(Chroma? clickedChroma)
        {
            if (clickedChroma == null) return;

            Debug.WriteLine($"[SkinDetailViewModel] ToggleChromaSelection called for Chroma ID: {clickedChroma.Id}");

            if (SelectedChroma == clickedChroma)
            {
                Debug.WriteLine($"[SkinDetailViewModel] Deselecting Chroma ID: {clickedChroma.Id}");
                SetDefaultSelection();
            }
            else
            {
                Debug.WriteLine($"[SkinDetailViewModel] Selecting Chroma ID: {clickedChroma.Id}");
                if (SelectedChroma != null)
                {
                    SelectedChroma.IsSelected = false;
                }
                SelectedChroma = clickedChroma;
                SelectedChroma.IsSelected = true;
                RefreshChromaSelections(SelectedChroma);
            }
        }

        private void RefreshChromaSelections(Chroma? selected)
        {
            foreach (var ch in AvailableChromas)
            {
                ch.IsSelected = (ch == selected);
            }
            var tempList = AvailableChromas.ToList();
            AvailableChromas.Clear();
            foreach (var item in tempList)
            {
                AvailableChromas.Add(item);
            }
        }
    }
}
/// ViewModels End of SkinDetailViewModel.cs ///

/// Services Start of CdragonDataService.cs ///
﻿using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading.Tasks;
using SkinHunterWPF.Models;
using System.Linq;
using System.IO;
using System.Net.Http.Headers;
using System.Diagnostics;

namespace SkinHunterWPF.Services
{
    public static class CdragonDataService
    {
        private static readonly HttpClient _httpClient = CreateHttpClient();
        private static readonly JsonSerializerOptions _jsonOptions = new() { PropertyNameCaseInsensitive = true };

        private const string CdragonBaseUrl = "https://raw.communitydragon.org/latest";
        private const string DataRoot = $"{CdragonBaseUrl}/plugins/rcp-be-lol-game-data/global/default";
        private static string? _cdragonVersion;

        private const string SupabaseUrl = "https://odlqwkgewzxxmbsqutja.supabase.co";
        private const string SupabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kbHF3a2dld3p4eG1ic3F1dGphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyMTM2NzcsImV4cCI6MjA0OTc4OTY3N30.qka6a71bavDeUQgy_BKoVavaClRQa_gT36Au7oO9AF0";
        private const string SupabaseStorageBasePath = "/storage/v1/object/public";

        private static HttpClient CreateHttpClient() => new();

        private static async Task<string> GetCdragonVersionAsync()
        {
            if (_cdragonVersion == null)
            {
                try
                {
                    var metaUrl = $"{CdragonBaseUrl}/content-metadata.json";
                    using var request = new HttpRequestMessage(HttpMethod.Get, metaUrl);
                    using var response = await _httpClient.SendAsync(request);
                    response.EnsureSuccessStatusCode();
                    using var json = await response.Content.ReadAsStreamAsync();
                    var metadata = await JsonSerializer.DeserializeAsync<Dictionary<string, JsonElement>>(json, _jsonOptions);
                    if (metadata != null && metadata.TryGetValue("version", out var versionElement))
                    {
                        _cdragonVersion = versionElement.GetString() ?? "latest";
                    }
                    else { _cdragonVersion = "latest"; }
                }
                catch (Exception ex)
                {
                    Debug.WriteLine($"[CdragonDataService] Error fetching CDRAGON version: {ex.Message}");
                    _cdragonVersion = "latest";
                }
            }
            return _cdragonVersion;
        }

        private static async Task<T?> FetchDataAsync<T>(string fullUrl, bool isSupabase = false) where T : class
        {
            var httpClientToUse = _httpClient;
            try
            {
                Debug.WriteLine($"[CdragonDataService] Fetching: {fullUrl}");
                using var request = new HttpRequestMessage(HttpMethod.Get, fullUrl);
                if (isSupabase)
                {
                    request.Headers.TryAddWithoutValidation("apikey", SupabaseAnonKey);
                }

                using var response = await httpClientToUse.SendAsync(request);
                response.EnsureSuccessStatusCode();

                byte[] contentBytes = await response.Content.ReadAsByteArrayAsync();

                if (contentBytes == null || contentBytes.Length == 0)
                {
                    Debug.WriteLine($"[CdragonDataService] Warning: Content bytes were null or empty for {Path.GetFileNameWithoutExtension(fullUrl)} despite 200 OK status.");
                    return null;
                }

                using var memoryStream = new MemoryStream(contentBytes);
                var result = await JsonSerializer.DeserializeAsync<T>(memoryStream, _jsonOptions);
                if (result != null)
                {
                    Debug.WriteLine($"[CdragonDataService] Successfully deserialized {Path.GetFileNameWithoutExtension(fullUrl)} into {typeof(T).Name}.");
                }
                else
                {
                    Debug.WriteLine($"[CdragonDataService] Deserialization of {Path.GetFileNameWithoutExtension(fullUrl)} into {typeof(T).Name} resulted in null.");
                }
                return result;
            }
            catch (HttpRequestException httpEx)
            {
                Debug.WriteLine($"[CdragonDataService] HTTP Error fetching {Path.GetFileNameWithoutExtension(fullUrl)}: {httpEx.Message} (Status: {httpEx.StatusCode})");
            }
            catch (JsonException jsonEx)
            {
                Debug.WriteLine($"[CdragonDataService] JSON Error parsing {Path.GetFileNameWithoutExtension(fullUrl)}: {jsonEx.Message}. LineNumber: {jsonEx.LineNumber}, BytePositionInLine: {jsonEx.BytePositionInLine}, Path: {jsonEx.Path}");
                try
                {
                    using var requestRetry = new HttpRequestMessage(HttpMethod.Get, fullUrl);
                    if (isSupabase) { requestRetry.Headers.TryAddWithoutValidation("apikey", SupabaseAnonKey); }
                    using var responseRetry = await httpClientToUse.SendAsync(requestRetry);
                    if (responseRetry.IsSuccessStatusCode)
                    {
                        string text = await responseRetry.Content.ReadAsStringAsync();
                        Debug.WriteLine($"[CdragonDataService] --- Raw JSON Content on Error for {Path.GetFileNameWithoutExtension(fullUrl)} ---\n{text}\n---------------------------------");
                    }
                }
                catch (Exception readEx)
                {
                    Debug.WriteLine($"[CdragonDataService] Could not read response as string on JSON error: {readEx.Message}");
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"[CdragonDataService] Generic Error fetching {Path.GetFileNameWithoutExtension(fullUrl)}: {ex.Message}");
            }
            return null;
        }

        private static async Task<SupabaseChampionData?> FetchChampionDataFromSupabaseAsync(int championId)
        {
            string bucket = "api_json";
            string filePath = $"{championId}.json";
            string supabaseFileUrl = $"{SupabaseUrl}{SupabaseStorageBasePath}/{bucket}/{filePath}";
            return await FetchDataAsync<SupabaseChampionData>(supabaseFileUrl, isSupabase: true);
        }


        public static async Task<List<ChampionSummary>?> GetChampionSummariesAsync()
        {
            _ = await GetCdragonVersionAsync();
            var url = $"{DataRoot}/v1/champion-summary.json";
            var summaries = await FetchDataAsync<List<ChampionSummary>>(url);
            return summaries?.Where(c => c.Id != -1).OrderBy(c => c.Name).ToList();
        }

        public static async Task<Dictionary<string, Skin>?> GetAllSkinsAsync()
        {
            _ = await GetCdragonVersionAsync();
            var url = $"{DataRoot}/v1/skins.json";
            Debug.WriteLine($"[CdragonDataService] Attempting to fetch and parse all skins from: {url}");
            var allSkins = await FetchDataAsync<Dictionary<string, Skin>>(url);
            if (allSkins != null)
            {
                Debug.WriteLine($"[CdragonDataService] Successfully fetched and parsed {allSkins.Count} total skins from skins.json.");
            }
            else
            {
                Debug.WriteLine($"[CdragonDataService] Failed to fetch or parse skins.json. allSkins is null.");
            }
            return allSkins;
        }

        public static async Task<ChampionDetail?> GetChampionDetailsAsync(int championId)
        {
            Debug.WriteLine($"[CdragonDataService] GetChampionDetailsAsync called for champion ID: {championId}");
            _ = await GetCdragonVersionAsync();
            var detailsUrl = $"{DataRoot}/v1/champions/{championId}.json";
            var championDetailWpf = await FetchDataAsync<ChampionDetail>(detailsUrl);

            if (championDetailWpf == null)
            {
                Debug.WriteLine($"[CdragonDataService] Failed to load champion details for {championId} from Cdragon champions/{championId}.json. Returning null.");
                return null;
            }

            var allSkinsFromCdragon = await GetAllSkinsAsync();
            var championDataFromSupabase = await FetchChampionDataFromSupabaseAsync(championId);

            if (championDataFromSupabase == null)
            {
                Debug.WriteLine($"[CdragonDataService] WARNING: Failed to load champion data for {championId} from Supabase. Chroma data might be sourced only from Cdragon/skins.json.");
            }
            else
            {
                Debug.WriteLine($"[CdragonDataService] Successfully loaded champion data for {championId} from Supabase. Contains {championDataFromSupabase.Skins?.Count ?? 0} skin entries.");
            }


            var skinsForThisChampionWpf = new List<Skin>();

            if (allSkinsFromCdragon != null)
            {
                Debug.WriteLine($"[CdragonDataService] Processing skins for champion ID {championId} from {allSkinsFromCdragon.Count} total Cdragon skins.");
                foreach (var cdragonSkinEntry in allSkinsFromCdragon.Where(kvp => kvp.Value.ChampionId == championId))
                {
                    Skin cdragonSkinObject = cdragonSkinEntry.Value;
                    string skinIdentifier = $"Skin ID: {cdragonSkinObject.Id} ('{cdragonSkinObject.Name}') for Champion ID: {championId}";
                    Debug.WriteLine($"[CdragonDataService] Processing {skinIdentifier}");

                    var currentWpfSkin = new Skin
                    {
                        Id = cdragonSkinObject.Id,
                        Name = cdragonSkinObject.Name,
                        TilePath = cdragonSkinObject.TilePath,
                        SplashPath = cdragonSkinObject.SplashPath,
                        RarityGemPath = cdragonSkinObject.RarityGemPath,
                        IsLegacy = cdragonSkinObject.IsLegacy,
                        Description = cdragonSkinObject.Description,
                        Chromas = new List<Chroma>()
                    };

                    var championJsonSkinInfo = championDetailWpf.Skins?.FirstOrDefault(s => s.Id == currentWpfSkin.Id);
                    if (!string.IsNullOrWhiteSpace(championJsonSkinInfo?.Description))
                    {
                        currentWpfSkin.Description = championJsonSkinInfo.Description;
                    }

                    SupabaseSkinData? supabaseSkinData = null;
                    if (championDataFromSupabase?.Skins != null)
                    {
                        supabaseSkinData = championDataFromSupabase.Skins.FirstOrDefault(s => s.Id == currentWpfSkin.Id);
                        if (supabaseSkinData == null)
                        {
                            Debug.WriteLine($"[CdragonDataService] {skinIdentifier}: No matching skin data found in Supabase champion data.");
                        }
                    }
                    else if (championDataFromSupabase != null && championDataFromSupabase.Skins == null)
                    {
                        Debug.WriteLine($"[CdragonDataService] {skinIdentifier}: Supabase champion data loaded, but its 'Skins' list is null.");
                    }


                    bool chromasPopulatedFromSupabase = false;
                    if (supabaseSkinData?.Chromas != null && supabaseSkinData.Chromas.Any())
                    {
                        Debug.WriteLine($"[CdragonDataService] {skinIdentifier}: Populating chromas from Supabase ({supabaseSkinData.Chromas.Count} found).");
                        foreach (var supabaseChroma in supabaseSkinData.Chromas)
                        {
                            if (supabaseChroma != null)
                            {
                                currentWpfSkin.Chromas.Add(new Chroma
                                {
                                    Id = supabaseChroma.Id,
                                    Name = supabaseChroma.Name,
                                    ChromaPath = supabaseChroma.ChromaPath,
                                    Colors = supabaseChroma.Colors != null ? new List<string>(supabaseChroma.Colors) : null
                                });
                                Debug.WriteLine($"[CdragonDataService] {skinIdentifier}: Added Supabase Chroma ID: {supabaseChroma.Id}, Name: '{supabaseChroma.Name}'");
                            }
                        }
                        chromasPopulatedFromSupabase = true;
                    }
                    else if (supabaseSkinData?.Chromas != null && !supabaseSkinData.Chromas.Any())
                    {
                        Debug.WriteLine($"[CdragonDataService] {skinIdentifier}: Supabase skin data found, but its 'Chromas' list is empty.");
                    }
                    else if (supabaseSkinData == null && championDataFromSupabase != null)
                    {
                    }


                    if (!chromasPopulatedFromSupabase && cdragonSkinObject.Chromas != null && cdragonSkinObject.Chromas.Any())
                    {
                        Debug.WriteLine($"[CdragonDataService] {skinIdentifier}: Supabase chromas not used or not found. Falling back to Cdragon/skins.json ({cdragonSkinObject.Chromas.Count} found).");
                        foreach (var cdragonChroma in cdragonSkinObject.Chromas)
                        {
                            if (cdragonChroma != null && !currentWpfSkin.Chromas.Any(ch => ch.Id == cdragonChroma.Id))
                            {
                                currentWpfSkin.Chromas.Add(new Chroma
                                {
                                    Id = cdragonChroma.Id,
                                    Name = cdragonChroma.Name,
                                    ChromaPath = cdragonChroma.ChromaPath,
                                    Colors = cdragonChroma.Colors != null ? new List<string>(cdragonChroma.Colors) : null
                                });
                                Debug.WriteLine($"[CdragonDataService] {skinIdentifier}: Added Cdragon/skins.json Chroma ID: {cdragonChroma.Id}, Name: '{cdragonChroma.Name}'");
                            }
                        }
                    }
                    else if (!chromasPopulatedFromSupabase)
                    {
                        Debug.WriteLine($"[CdragonDataService] {skinIdentifier}: No chromas found from Supabase, and Cdragon/skins.json also has no chromas (or 'Chromas' list is null).");
                    }

                    Debug.WriteLine($"[CdragonDataService] {skinIdentifier}: Final chromas count for skin: {currentWpfSkin.Chromas.Count}");
                    currentWpfSkin.Chromas = currentWpfSkin.Chromas.OrderBy(c => c.Id).ToList();
                    skinsForThisChampionWpf.Add(currentWpfSkin);
                }
            }
            else
            {
                Debug.WriteLine($"[CdragonDataService] WARNING: allSkinsFromCdragon (cdn/v1/skins.json) was null. Cannot process any skins for champion {championId}.");
            }

            championDetailWpf.Skins = skinsForThisChampionWpf.OrderBy(s => s.Name).ToList();
            Debug.WriteLine($"[CdragonDataService] GetChampionDetailsAsync for champion ID {championId} finished. Total skins populated: {championDetailWpf.Skins.Count}");
            return championDetailWpf;
        }


        public static string GetAssetUrl(string? relativePath)
        {
            if (string.IsNullOrWhiteSpace(relativePath))
            {
                return "pack://application:,,,/Assets/placeholder.png";
            }

            if (Uri.TryCreate(relativePath, UriKind.Absolute, out Uri? uriResult) &&
                (uriResult.Scheme == Uri.UriSchemeHttp || uriResult.Scheme == Uri.UriSchemeHttps))
            {
                return relativePath;
            }

            const string apiAssetPrefix = "/lol-game-data/assets";
            if (relativePath.StartsWith(apiAssetPrefix, StringComparison.OrdinalIgnoreCase))
            {
                var pathSegment = relativePath[apiAssetPrefix.Length..].TrimStart('/');
                return $"{DataRoot}/{pathSegment}".ToLowerInvariant();
            }
            return $"{DataRoot}/{relativePath.TrimStart('/')}".ToLowerInvariant();
        }
    }
}
/// Services End of CdragonDataService.cs ///

/// Services Start of ImageService.cs ///
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace SkinHunterWPF.Services
{
    internal class ImageService
    {
    }
}
/// Services End of ImageService.cs ///

/// Services Start of INavigationService.cs ///
﻿namespace SkinHunterWPF.Services
{
    public interface INavigationService
    {
        void NavigateTo<TViewModel>() where TViewModel : ViewModels.BaseViewModel;
        void NavigateTo<TViewModel>(object parameter) where TViewModel : ViewModels.BaseViewModel;
        void ShowDialog<TViewModel>(object parameter) where TViewModel : ViewModels.BaseViewModel;
        void GoBack();
    }
}
/// Services End of INavigationService.cs ///

/// Services Start of NavigationService.cs ///
﻿using SkinHunterWPF.ViewModels;
using SkinHunterWPF.Models;
using System;
using Microsoft.Extensions.DependencyInjection;
using System.Linq;

namespace SkinHunterWPF.Services
{
    public class NavigationService : INavigationService
    {
        private readonly IServiceProvider _serviceProvider;
        private BaseViewModel? _previousViewModel;
        private MainViewModel? _mainViewModelCache;

        public NavigationService(IServiceProvider serviceProvider)
        {
            _serviceProvider = serviceProvider;
        }

        private MainViewModel MainVM => _mainViewModelCache ??= _serviceProvider.GetRequiredService<MainViewModel>();

        private BaseViewModel GetViewModel<TViewModel>() where TViewModel : BaseViewModel
        {
            return _serviceProvider.GetRequiredService<TViewModel>();
        }

        private void SetCurrentViewModel(BaseViewModel viewModel)
        {
            _previousViewModel = MainVM.CurrentViewModel;
            MainVM.CurrentViewModel = viewModel;
        }

        public void NavigateTo<TViewModel>() where TViewModel : BaseViewModel
        {
            var viewModel = GetViewModel<TViewModel>();
            SetCurrentViewModel(viewModel);
            if (viewModel is ChampionGridViewModel cgvm && !cgvm.ChampionsView.Cast<object>().Any())
            {
                _ = cgvm.LoadChampionsCommand.ExecuteAsync(null);
            }
        }

        public void NavigateTo<TViewModel>(object parameter) where TViewModel : BaseViewModel
        {
            var viewModel = GetViewModel<TViewModel>();

            if (viewModel is ChampionDetailViewModel cdvm && parameter is int champId)
            {
                _ = cdvm.LoadChampionCommand.ExecuteAsync(champId);
            }

            SetCurrentViewModel(viewModel);
        }

        public void ShowDialog<TViewModel>(object parameter) where TViewModel : BaseViewModel
        {
            if (typeof(TViewModel) == typeof(SkinDetailViewModel) && parameter is Skin skinToShow)
            {
                var viewModel = _serviceProvider.GetRequiredService<SkinDetailViewModel>();
                viewModel.LoadSkin(skinToShow);
                MainVM.DialogViewModel = viewModel;
            }
            else
            {
                Console.WriteLine($"Cannot show dialog for VM {typeof(TViewModel)} with parameter {parameter?.GetType()}");
                MainVM.DialogViewModel = null;
            }
        }

        public void GoBack()
        {
            if (MainVM.DialogViewModel != null)
            {
                MainVM.DialogViewModel = null;
                return;
            }

            if (_previousViewModel != null)
            {
                var currentType = MainVM.CurrentViewModel?.GetType();
                var previousType = _previousViewModel.GetType();

                if (currentType != previousType)
                {
                    MainVM.CurrentViewModel = _previousViewModel;
                    _previousViewModel = _serviceProvider.GetService<ChampionGridViewModel>();
                }
                else
                {
                    NavigateTo<ChampionGridViewModel>();
                }

            }
            else
            {
                NavigateTo<ChampionGridViewModel>();
            }
        }
    }
}
/// Services End of NavigationService.cs ///

/// Models Start of ChampionDetail.cs ///
﻿using System.Collections.Generic;
using System.Text.Json.Serialization;

namespace SkinHunterWPF.Models
{
    public class ChampionDetail : ChampionSummary
    {
        [JsonPropertyName("title")]
        public string Title { get; set; } = string.Empty;

        [JsonPropertyName("shortBio")]
        public string ShortBio { get; set; } = string.Empty;

        [JsonIgnore]
        public List<Skin> Skins { get; set; } = new List<Skin>();
    }
}
/// Models End of ChampionDetail.cs ///

/// Models Start of ChampionSummary.cs ///
﻿using CommunityToolkit.Mvvm.ComponentModel;
using SkinHunterWPF.Services;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Net.Http;
using System.Text.Json.Serialization;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Media.Imaging;
using System.Windows.Threading;

namespace SkinHunterWPF.Models
{
    public partial class ChampionSummary : ObservableObject
    {
        [JsonPropertyName("id")]
        public int Id { get; set; }

        [JsonPropertyName("name")]
        public string Name { get; set; } = string.Empty;

        [JsonPropertyName("alias")]
        public string Alias { get; set; } = string.Empty;

        [JsonPropertyName("squarePortraitPath")]
        public string SquarePortraitPath { get; set; } = string.Empty;

        [JsonPropertyName("roles")]
        public List<string>? Roles { get; set; }

        private BitmapImage? _championImageSourceField;

        [JsonIgnore]
        public BitmapImage? ChampionImageSource
        {
            get
            {
                if (_championImageSourceField == null || _championImageSourceField == _placeholderImage)
                {
                    if (!_isImageLoading && !string.IsNullOrEmpty(OriginalImageUrl) && !OriginalImageUrl.StartsWith("pack:"))
                    {
                        _ = LoadImageAsync();
                    }
                    return _placeholderImage;
                }
                return _championImageSourceField;
            }
            private set
            {
                SetProperty(ref _championImageSourceField, value);
            }
        }

        public void ReleaseImage() // MÉTODO AÑADIDO/ASEGURADO
        {
            Debug.WriteLine($"[ChampionSummary] Liberando imagen para {Name}");
            if (System.Windows.Application.Current != null)
            {
                System.Windows.Application.Current.Dispatcher.Invoke(() =>
                {
                    if (_championImageSourceField != _placeholderImage)
                    {
                        CancelCurrentLoad();
                        ChampionImageSource = _placeholderImage;
                        Debug.WriteLine($"[ChampionSummary] Imagen para {Name} establecida a placeholder.");
                    }
                });
            }
            else
            {
                if (_championImageSourceField != _placeholderImage)
                {
                    CancelCurrentLoad();
                    _championImageSourceField = _placeholderImage;
                    OnPropertyChanged(nameof(ChampionImageSource));
                    Debug.WriteLine($"[ChampionSummary] Imagen para {Name} establecida a placeholder (sin Dispatcher).");
                }
            }
        }


        [JsonIgnore]
        private volatile bool _isImageLoading = false;
        [JsonIgnore]
        private static readonly HttpClient _httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(15) };
        [JsonIgnore]
        private static readonly Dictionary<string, BitmapImage> _imageCache = new Dictionary<string, BitmapImage>(StringComparer.OrdinalIgnoreCase);
        [JsonIgnore]
        private static readonly BitmapImage? _placeholderImage = LoadPlaceholderImage();

        private CancellationTokenSource? _cancellationTokenSource;

        private async Task LoadImageAsync()
        {
            if (_isImageLoading) return;
            _isImageLoading = true;

            _cancellationTokenSource?.Cancel();
            _cancellationTokenSource = new CancellationTokenSource();
            var token = _cancellationTokenSource.Token;

            string imageUrl = OriginalImageUrl;
            BitmapImage? finalImage = null;

            if (string.IsNullOrEmpty(imageUrl) || imageUrl.StartsWith("pack:"))
            {
                finalImage = _placeholderImage;
            }
            else
            {
                lock (_imageCache)
                {
                    if (_imageCache.TryGetValue(imageUrl, out var cachedImageFromLock))
                    {
                        finalImage = cachedImageFromLock;
                        Debug.WriteLine($"[ImageLoad] Cache HIT: {imageUrl} for {Name}");
                    }
                }

                if (finalImage == null)
                {
                    try
                    {
                        Debug.WriteLine($"[ImageLoad] Loading: {imageUrl} for {Name}");
                        using var request = new HttpRequestMessage(HttpMethod.Get, imageUrl);
                        using var response = await _httpClient.SendAsync(request, HttpCompletionOption.ResponseHeadersRead, token);
                        response.EnsureSuccessStatusCode();
                        byte[] imageData = await response.Content.ReadAsByteArrayAsync(token);

                        if (token.IsCancellationRequested)
                        {
                            Debug.WriteLine($"[ImageLoad] Cancelled during download: {imageUrl} for {Name}");
                            _isImageLoading = false;
                            if (System.Windows.Application.Current != null)
                                System.Windows.Application.Current.Dispatcher.Invoke(() => ChampionImageSource = _placeholderImage);
                            else
                                ChampionImageSource = _placeholderImage;
                            return;
                        }

                        var bitmap = new BitmapImage();
                        using (var stream = new MemoryStream(imageData))
                        {
                            bitmap.BeginInit();
                            bitmap.CacheOption = BitmapCacheOption.OnLoad;
                            bitmap.DecodePixelWidth = 80;
                            bitmap.StreamSource = stream;
                            bitmap.EndInit();
                        }
                        bitmap.Freeze();
                        finalImage = bitmap;

                        lock (_imageCache)
                        {
                            _imageCache.TryAdd(imageUrl, finalImage);
                        }
                        Debug.WriteLine($"[ImageLoad] Loaded and Cached: {imageUrl} for {Name}");
                    }
                    catch (OperationCanceledException)
                    {
                        Debug.WriteLine($"[ImageLoad] Cancelled (OperationCanceledException): {imageUrl} for {Name}");
                        finalImage = _placeholderImage;
                    }
                    catch (Exception ex)
                    {
                        Debug.WriteLine($"[ImageLoad] Error loading image {imageUrl} for {Name}: {ex.Message}");
                        finalImage = _placeholderImage;
                    }
                }
            }

            if (System.Windows.Application.Current != null)
            {
                System.Windows.Application.Current.Dispatcher.Invoke(() =>
                {
                    if (!token.IsCancellationRequested)
                    {
                        ChampionImageSource = finalImage ?? _placeholderImage;
                    }
                    else
                    {
                        ChampionImageSource = _placeholderImage;
                        Debug.WriteLine($"[ImageLoad] Carga para {Name} fue cancelada antes de asignación en Dispatcher.");
                    }
                });
            }
            else
            {
                ChampionImageSource = finalImage ?? _placeholderImage;
            }
            _isImageLoading = false;
        }

        public void CancelCurrentLoad()
        {
            if (_isImageLoading)
            {
                Debug.WriteLine($"[ChampionSummary] Cancelando carga de imagen para {Name}.");
                _cancellationTokenSource?.Cancel();
                _isImageLoading = false;
            }
        }

        [JsonIgnore]
        public string OriginalImageUrl => CdragonDataService.GetAssetUrl(SquarePortraitPath);

        [JsonIgnore]
        public string Key => Alias?.ToLowerInvariant() ?? string.Empty;

        private static BitmapImage? LoadPlaceholderImage()
        {
            try
            {
                var placeholder = new BitmapImage();
                placeholder.BeginInit();
                placeholder.UriSource = new Uri("pack://application:,,,/Assets/placeholder.png", UriKind.Absolute);
                placeholder.DecodePixelWidth = 80;
                placeholder.CacheOption = BitmapCacheOption.OnLoad;
                placeholder.EndInit();
                placeholder.Freeze();
                return placeholder;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"[ImageLoad] Failed to load placeholder image: {ex.Message}");
                return null;
            }
        }
    }
}
/// Models End of ChampionSummary.cs ///

/// Models Start of Chroma.cs ///
﻿using System.Text.Json.Serialization;
using System.Collections.Generic;
using System.Windows.Media;

namespace SkinHunterWPF.Models
{
    public class Chroma
    {
        [JsonPropertyName("id")]
        public int Id { get; set; }

        [JsonPropertyName("name")]
        public string Name { get; set; } = string.Empty;

        [JsonPropertyName("chromaPath")]
        public string ChromaPath { get; set; } = string.Empty;

        [JsonPropertyName("colors")]
        public List<string>? Colors { get; set; }

        [JsonIgnore]
        public string ImageUrl => Services.CdragonDataService.GetAssetUrl(ChromaPath);

        [JsonIgnore]
        public System.Windows.Media.Brush? ColorBrush
        {
            get
            {
                if (Colors == null || Colors.Count == 0) return System.Windows.Media.Brushes.Gray;
                if (Colors.Count == 1)
                {
                    try { return new SolidColorBrush((System.Windows.Media.Color)System.Windows.Media.ColorConverter.ConvertFromString(Colors[0])); }
                    catch { return System.Windows.Media.Brushes.Gray; }
                }
                try
                {
                    var gradient = new LinearGradientBrush
                    {
                        StartPoint = new System.Windows.Point(0, 0.5),
                        EndPoint = new System.Windows.Point(1, 0.5)
                    };
                    gradient.GradientStops.Add(new GradientStop((System.Windows.Media.Color)System.Windows.Media.ColorConverter.ConvertFromString(Colors[0]), 0.0));
                    gradient.GradientStops.Add(new GradientStop((System.Windows.Media.Color)System.Windows.Media.ColorConverter.ConvertFromString(Colors[1]), 1.0));
                    return gradient;
                }
                catch { return System.Windows.Media.Brushes.Gray; }
            }
        }

        [JsonIgnore]
        private bool _isSelected;

        [JsonIgnore]
        public bool IsSelected
        {
            get => _isSelected;
            set
            {
                _isSelected = value;
            }
        }
    }
}
/// Models End of Chroma.cs ///

/// Models Start of SearchResultItem.cs ///
﻿using CommunityToolkit.Mvvm.ComponentModel;
using SkinHunterWPF.Services;
using System.Windows.Media.Imaging;
using System;
using System.Threading.Tasks;

namespace SkinHunterWPF.Models
{
    public enum SearchResultType
    {
        Champion,
        Skin
    }

    public partial class SearchResultItem : ObservableObject
    {
        public int Id { get; }
        public string Name { get; }
        public SearchResultType Type { get; }
        public string DisplayType { get; }

        [ObservableProperty]
        private BitmapImage? _imageSource;

        private readonly string? _imagePath; // Marcado como readonly

        public int ChampionId { get; }
        public Skin? OriginalSkinObject { get; }
        public ChampionSummary? OriginalChampionObject { get; }


        public SearchResultItem(ChampionSummary champion)
        {
            Id = champion.Id;
            Name = champion.Name;
            Type = SearchResultType.Champion;
            DisplayType = "Champion";
            _imagePath = champion.SquarePortraitPath;
            ChampionId = champion.Id;
            OriginalChampionObject = champion;
        }

        public SearchResultItem(Skin skin, ChampionSummary? parentChampion)
        {
            Id = skin.Id;
            Name = skin.Name;
            Type = SearchResultType.Skin;
            DisplayType = "Champion Skin";
            _imagePath = skin.TilePath;
            ChampionId = skin.ChampionId;
            OriginalSkinObject = skin;
            OriginalChampionObject = parentChampion;
        }

        public Task LoadImageAsync()
        {
            if (ImageSource == null && !string.IsNullOrEmpty(_imagePath)) // Usar propiedad generada ImageSource
            {
                try
                {
                    var bitmap = new BitmapImage();
                    bitmap.BeginInit();
                    bitmap.UriSource = new Uri(CdragonDataService.GetAssetUrl(_imagePath), UriKind.Absolute);
                    bitmap.DecodePixelWidth = 64;
                    bitmap.CacheOption = BitmapCacheOption.OnLoad;
                    bitmap.EndInit();
                    bitmap.Freeze();
                    ImageSource = bitmap; // Usar propiedad generada
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"Error loading search result image {_imagePath}: {ex.Message}");
                }
            }
            return Task.CompletedTask; // Para satisfacer async y quitar advertencia CS1998
        }
    }
}
/// Models End of SearchResultItem.cs ///

/// Models Start of Skin.cs ///
﻿using System.Text.Json.Serialization;
using System.Collections.Generic;
using System.Linq;

namespace SkinHunterWPF.Models
{
    public class Skin
    {
        [JsonPropertyName("id")]
        public int Id { get; set; }

        [JsonPropertyName("name")]
        public string Name { get; set; } = string.Empty;

        [JsonPropertyName("tilePath")]
        public string TilePath { get; set; } = string.Empty;

        [JsonPropertyName("splashPath")]
        public string SplashPath { get; set; } = string.Empty;

        [JsonPropertyName("rarityGemPath")]
        public string? RarityGemPath { get; set; }

        [JsonPropertyName("isLegacy")]
        public bool IsLegacy { get; set; }

        [JsonPropertyName("description")]
        public string? Description { get; set; }

        [JsonPropertyName("chromas")]
        public List<Chroma>? Chromas { get; set; }

        public string TileImageUrl => Services.CdragonDataService.GetAssetUrl(TilePath);
        public string SplashImageUrl => Services.CdragonDataService.GetAssetUrl(SplashPath);
        public string? RarityImageUrl => RarityGemPath != null ? Services.CdragonDataService.GetAssetUrl(RarityGemPath) : null;
        public string RarityName => GetRarityNameFromPath(RarityGemPath);
        public int ChampionId => Id / 1000;
        public bool HasChromas => Chromas?.Any() ?? false;

        private static string GetRarityNameFromPath(string? path)
        {
            if (string.IsNullOrEmpty(path)) return "Standard";
            if (path.Contains("ultimate")) return "Ultimate";
            if (path.Contains("mythic")) return "Mythic";
            if (path.Contains("legendary")) return "Legendary";
            if (path.Contains("epic")) return "Epic";
            if (path.Contains("transcendent")) return "Transcendent";
            if (path.Contains("exalted")) return "Exalted";
            return "Unknown";
        }
    }
}
/// Models End of Skin.cs ///

/// Models Start of Skinline.cs ///
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace SkinHunterWPF.Models
{
    internal class Skinline
    {
    }
}
/// Models End of Skinline.cs ///

/// Models Start of SupabaseDataModels.cs ///
﻿using System.Collections.Generic;
using System.Text.Json.Serialization;

namespace SkinHunterWPF.Models
{
    public class SupabaseChampionData
    {
        [JsonPropertyName("id")]
        public int Id { get; set; }

        [JsonPropertyName("name")]
        public string Name { get; set; } = string.Empty;


        [JsonPropertyName("skins")]
        public List<SupabaseSkinData>? Skins { get; set; }
    }

    public class SupabaseSkinData
    {
        [JsonPropertyName("id")]
        public int Id { get; set; }

        [JsonPropertyName("name")]
        public string Name { get; set; } = string.Empty;


        [JsonPropertyName("chromas")]
        public List<SupabaseChromaData>? Chromas { get; set; }
    }

    public class SupabaseChromaData
    {
        [JsonPropertyName("id")]
        public int Id { get; set; }

        [JsonPropertyName("name")]
        public string Name { get; set; } = string.Empty;

        [JsonPropertyName("chromaPath")]
        public string ChromaPath { get; set; } = string.Empty;

        [JsonPropertyName("colors")]
        public List<string>? Colors { get; set; }
    }
}
/// Models End of SupabaseDataModels.cs ///

/// Converters Start of BooleanToVisibilityConverter.cs ///
﻿using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace SkinHunterWPF.Converters
{
    [ValueConversion(typeof(bool), typeof(Visibility))]
    public class BooleanToVisibilityConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            bool flag = false;
            if (value is bool b)
            {
                flag = b;
            }
            else if (value is bool?)
            {
                bool? nullable = (bool?)value;
                flag = nullable.HasValue && nullable.Value;
            }

            bool inverse = (parameter as string) == "Inverse";
            if (inverse)
            {
                flag = !flag;
            }

            return flag ? Visibility.Visible : Visibility.Collapsed;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            bool inverse = (parameter as string) == "Inverse";
            bool flag = (value is Visibility visibility) && visibility == Visibility.Visible;

            if (inverse)
            {
                flag = !flag;
            }
            return flag;
        }
    }
}
/// Converters End of BooleanToVisibilityConverter.cs ///

/// Converters Start of ChromaToButtonTextConverter.cs ///
﻿using System;
using System.Globalization;
using System.Windows.Data;
using SkinHunterWPF.Models;

namespace SkinHunterWPF.Converters
{
    public class ChromaToButtonTextConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            return value is Chroma ? "Download Chroma" : "Download Skin";
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
/// Converters End of ChromaToButtonTextConverter.cs ///

/// Converters Start of InverseBooleanToVisibilityConverter.cs ///
﻿using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace SkinHunterWPF.Converters
{
    [ValueConversion(typeof(bool), typeof(Visibility))]
    public class InverseBooleanToVisibilityConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            bool flag = false;
            if (value is bool b)
            {
                flag = b;
            }
            else if (value is bool?)
            {
                bool? nullable = (bool?)value;
                flag = nullable.HasValue && nullable.Value;
            }

            return !flag ? Visibility.Visible : Visibility.Collapsed;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            return (value is Visibility visibility) && visibility != Visibility.Visible;
        }
    }
}
/// Converters End of InverseBooleanToVisibilityConverter.cs ///

/// Converters Start of ListToStringConverter.cs ///
﻿using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Windows.Data;

namespace SkinHunterWPF.Converters
{
    public class ListToStringConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is IEnumerable<string> list && list.Any())
            {
                return string.Join(", ", list.Select(r => r.Length > 0 ? char.ToUpper(r[0]) + r.Substring(1) : r));
            }
            return string.Empty;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
/// Converters End of ListToStringConverter.cs ///

/// Converters Start of NullOrEmptyToVisibilityConverter.cs ///
﻿using System;
using System.Collections;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace SkinHunterWPF.Converters
{
    [ValueConversion(typeof(object), typeof(Visibility))]
    public class NullOrEmptyToVisibilityConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            bool isNullOrEmpty;

            if (value == null)
            {
                isNullOrEmpty = true;
            }
            else if (value is string s)
            {
                isNullOrEmpty = string.IsNullOrEmpty(s);
            }
            else if (value is ICollection c)
            {
                isNullOrEmpty = c.Count == 0;
            }
            else
            {
                isNullOrEmpty = false;
            }

            bool collapseWhenNullOrEmpty = true;
            if (parameter is string paramString && bool.TryParse(paramString, out bool paramBool))
            {
                collapseWhenNullOrEmpty = paramBool;
            }
            else if (parameter is bool directBool)
            {
                collapseWhenNullOrEmpty = directBool;
            }


            if (collapseWhenNullOrEmpty)
            {
                return isNullOrEmpty ? Visibility.Collapsed : Visibility.Visible;
            }
            else
            {
                return isNullOrEmpty ? Visibility.Visible : Visibility.Collapsed;
            }
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
/// Converters End of NullOrEmptyToVisibilityConverter.cs ///

/// Converters Start of NullToVisibilityConverter.cs ///
﻿using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace SkinHunterWPF.Converters
{
    [ValueConversion(typeof(object), typeof(Visibility))]
    public class NullToVisibilityConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            bool isNull = value == null;
            bool collapseWhenNull = true;

            if (parameter is string paramString && bool.TryParse(paramString, out bool paramBool))
            {
                collapseWhenNull = paramBool;
            }

            if (collapseWhenNull)
            {
                return isNull ? Visibility.Collapsed : Visibility.Visible;
            }
            else
            {
                return isNull ? Visibility.Visible : Visibility.Collapsed;
            }
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
/// Converters End of NullToVisibilityConverter.cs ///

/// Converters Start of SkinIdToKhadaUrlConverter.cs ///
﻿using System;
using System.Globalization;
using System.Windows.Data;

namespace SkinHunterWPF.Converters
{
    public class SkinIdToKhadaUrlConverter : IValueConverter
    {
        private const string BaseKhadaUrl = "https://modelviewer.lol/model-viewer?id=";

        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is int skinId && skinId > 0)
            {
                string url = $"{BaseKhadaUrl}{skinId}";
                if (parameter is int chromaId && chromaId > 0 && chromaId / 1000 == skinId)
                {
                    url += $"&chroma={chromaId}";
                }
                return url;
            }
            return BaseKhadaUrl;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
/// Converters End of SkinIdToKhadaUrlConverter.cs ///

/// Converters Start of TypeCheckConverter.cs ///
﻿using System;
using System.Globalization;
using System.Windows.Data;

namespace SkinHunterWPF.Converters
{
    public class TypeCheckConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value == null || !(parameter is Type typeToCheck))
            {
                return false;
            }
            return typeToCheck.IsInstanceOfType(value);
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
/// Converters End of TypeCheckConverter.cs ///

/// Root Start of App.xaml ///
﻿<Application x:Class="SkinHunterWPF.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:SkinHunterWPF.Converters">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
            </ResourceDictionary.MergedDictionaries>

            <Color x:Key="BaseBackgroundColorValue">#1E1E1E</Color>
            <Color x:Key="BaseForegroundColorValue">#E0E0E0</Color>
            <Color x:Key="BaseAccentColorValue">#007ACC</Color>
            <Color x:Key="BaseCardBackgroundColorValue">#282828</Color>
            <Color x:Key="BaseSubtleBorderColorValue">#3A3A3A</Color>
            <Color x:Key="BaseHoverBackgroundColorValue">#333333</Color>

            <SolidColorBrush x:Key="WindowBackgroundColor" Color="{StaticResource BaseBackgroundColorValue}"/>
            <SolidColorBrush x:Key="HeaderBackgroundColor" Color="#181818"/>
            <SolidColorBrush x:Key="BorderAccentColor" Color="{StaticResource BaseAccentColorValue}"/>
            <SolidColorBrush x:Key="ForegroundColor" Color="{StaticResource BaseForegroundColorValue}"/>
            <SolidColorBrush x:Key="ForegroundLightGray" Color="#B0B0B0"/>
            <SolidColorBrush x:Key="ForegroundGray" Color="#888888"/>
            <SolidColorBrush x:Key="CardBackgroundColor" Color="{StaticResource BaseCardBackgroundColorValue}"/>
            <SolidColorBrush x:Key="CardBorderColor" Color="{StaticResource BaseSubtleBorderColorValue}"/>
            <SolidColorBrush x:Key="ButtonPrimaryBrush" Color="{StaticResource BaseAccentColorValue}"/>
            <SolidColorBrush x:Key="ButtonDefaultBrush" Color="#383838"/>
            <SolidColorBrush x:Key="ButtonHoverBrush" Color="{StaticResource BaseHoverBackgroundColorValue}"/>
            <SolidColorBrush x:Key="ButtonDisabledBrush" Color="#2A2A2A"/>
            <SolidColorBrush x:Key="ScrollBarBackgroundBrush" Color="#252525"/>
            <SolidColorBrush x:Key="ScrollBarThumbBrush" Color="#505050"/>
            <SolidColorBrush x:Key="ScrollBarThumbHoverBrush" Color="#686868"/>

            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <converters:NullOrEmptyToVisibilityConverter x:Key="NullOrEmptyToVisibilityConverter"/>
            <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
            <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
            <converters:ChromaToButtonTextConverter x:Key="ChromaToButtonTextConverter"/>
            <converters:SkinIdToKhadaUrlConverter x:Key="SkinIdToKhadaUrlConverter"/>
            <converters:ListToStringConverter x:Key="ListToStringConverter"/>

            <Style TargetType="Button">
                <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                <Setter Property="Background" Value="{StaticResource ButtonDefaultBrush}"/>
                <Setter Property="BorderBrush" Value="{StaticResource CardBorderColor}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="Padding" Value="10,6"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="SnapsToDevicePixels" Value="True"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="border"
                                     Background="{TemplateBinding Background}"
                                     BorderBrush="{TemplateBinding BorderBrush}"
                                     BorderThickness="{TemplateBinding BorderThickness}"
                                     CornerRadius="3">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="{StaticResource ButtonHoverBrush}"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="{StaticResource BorderAccentColor}"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter TargetName="border" Property="Background" Value="{StaticResource ButtonDisabledBrush}"/>
                                    <Setter Property="BorderBrush" Value="#404040"/>
                                    <Setter TargetName="border" Property="Opacity" Value="0.6"/>
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundGray}"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="TitleBarButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Width" Value="46"/>
                <Setter Property="Height" Value="35"/>
                <Setter Property="Padding" Value="0"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="Foreground" Value="{StaticResource ForegroundGray}"/>
                <Setter Property="WindowChrome.IsHitTestVisibleInChrome" Value="True"/>
                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="border" Background="{TemplateBinding Background}" SnapsToDevicePixels="true" CornerRadius="3">
                                <ContentPresenter x:Name="contentPresenter" HorizontalAlignment="Center" VerticalAlignment="Center" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="#44AAAAAA"/>
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundLightGray}"/>
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="#66999999"/>
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Opacity" Value="0.5"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="CloseButtonStyle" TargetType="Button" BasedOn="{StaticResource TitleBarButtonStyle}">
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="#E81123"/>
                        <Setter Property="Foreground" Value="White"/>
                    </Trigger>
                    <Trigger Property="IsPressed" Value="True">
                        <Setter Property="Background" Value="#F1707A"/>
                        <Setter Property="Foreground" Value="White"/>
                    </Trigger>
                </Style.Triggers>
            </Style>

            <Style x:Key="ButtonIconOnlyStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Padding" Value="5"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="HorizontalAlignment" Value="Center"/>
                <Setter Property="Foreground" Value="{StaticResource ForegroundGray}"/>
                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="border" Background="{TemplateBinding Background}" SnapsToDevicePixels="true" CornerRadius="4">
                                <ContentPresenter x:Name="contentPresenter" HorizontalAlignment="Center" VerticalAlignment="Center" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="#44666666"/>
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundLightGray}"/>
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="#66555555"/>
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Opacity" Value="0.5"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="ChampionGridButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Padding" Value="0"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Margin" Value="4"/>
                <Setter Property="Width" Value="100"/>
                <Setter Property="Height" Value="110"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="Bd" Height="110" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="3">
                                <ContentPresenter/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Bd" Property="Background" Value="{StaticResource ButtonHoverBrush}"/>
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="Bd" Property="Background" Value="{StaticResource BorderAccentColor}"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="ButtonTransparentStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Padding" Value="0"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" x:Name="Bd">
                                <ContentPresenter/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Bd" Property="Effect">
                                        <Setter.Value>
                                            <DropShadowEffect ShadowDepth="0" Color="{StaticResource BaseAccentColorValue}" Opacity="0.5" BlurRadius="8"/>
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="ButtonPrimaryStyle" TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                <Setter Property="Background" Value="{StaticResource ButtonPrimaryBrush}"/>
                <Setter Property="BorderBrush" Value="{StaticResource ButtonPrimaryBrush}"/>
                <Setter Property="Foreground" Value="White"/>
            </Style>

            <Style x:Key="CardBorderStyle" TargetType="Border">
                <Setter Property="Background" Value="{StaticResource CardBackgroundColor}"/>
                <Setter Property="BorderBrush" Value="{StaticResource CardBorderColor}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="CornerRadius" Value="4"/>
                <Setter Property="Padding" Value="5"/>
            </Style>

            <Style x:Key="LoadingProgressBarStyle" TargetType="ProgressBar">
                <Setter Property="IsIndeterminate" Value="True"/>
                <Setter Property="Width" Value="40"/>
                <Setter Property="Height" Value="40"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="HorizontalAlignment" Value="Center"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Foreground" Value="{StaticResource BorderAccentColor}"/>
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="ProgressBar" >
                            <Grid>
                                <Ellipse Stroke="{TemplateBinding Foreground}" StrokeThickness="3" Opacity="0.2"/>
                                <Path Name="PART_Indicator" Stroke="{TemplateBinding Foreground}" StrokeThickness="3" StrokeStartLineCap="Round" StrokeEndLineCap="Round"
                                      Data="M20,2 A18,18 0 0 1 38,20">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="0" CenterX="20" CenterY="20" />
                                    </Path.RenderTransform>
                                    <Path.Triggers>
                                        <EventTrigger RoutedEvent="Loaded">
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetName="PART_Indicator" Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)" From="0" To="360" Duration="0:0:1.2" RepeatBehavior="Forever"/>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                    </Path.Triggers>
                                </Path>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style TargetType="TabControl">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Padding" Value="0"/>
            </Style>

            <Style TargetType="TabItem">
                <Setter Property="Foreground" Value="{StaticResource ForegroundLightGray}"/>
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="Padding" Value="12,6"/>
                <Setter Property="BorderThickness" Value="0 0 0 2"/>
                <Setter Property="BorderBrush" Value="Transparent"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="TabItem">
                            <Border x:Name="border"
                                     BorderThickness="{TemplateBinding BorderThickness}"
                                     BorderBrush="{TemplateBinding BorderBrush}"
                                     Background="{TemplateBinding Background}"
                                     Padding="{TemplateBinding Padding}"
                                     Margin="0,0,8,0" CornerRadius="3,3,0,0">
                                <ContentPresenter ContentSource="Header"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                                    <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                                    <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                    <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="TextBoxWithPlaceholder" TargetType="TextBox">
                <Setter Property="Background" Value="{StaticResource CardBackgroundColor}"/>
                <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                <Setter Property="BorderBrush" Value="{StaticResource CardBorderColor}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="Padding" Value="8,0"/>
                <Setter Property="VerticalContentAlignment" Value="Center"/>
                <Setter Property="CaretBrush" Value="{StaticResource ForegroundLightGray}"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="TextBox">
                            <Grid>
                                <Border x:Name="border" Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            CornerRadius="3"/>
                                <ScrollViewer x:Name="PART_ContentHost" Margin="{TemplateBinding Padding}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                <TextBlock Text="{Binding Tag, RelativeSource={RelativeSource TemplatedParent}}"
                                               Foreground="{StaticResource ForegroundGray}"
                                               Margin="{TemplateBinding Padding}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                               Visibility="Collapsed" x:Name="PlaceholderText" IsHitTestVisible="False"/>
                            </Grid>
                            <ControlTemplate.Triggers>
                                <MultiTrigger>
                                    <MultiTrigger.Conditions>
                                        <Condition Property="IsFocused" Value="False"/>
                                        <Condition Property="Text" Value=""/>
                                    </MultiTrigger.Conditions>
                                    <Setter Property="Visibility" TargetName="PlaceholderText" Value="Visible"/>
                                </MultiTrigger>
                                <Trigger Property="IsFocused" Value="True">
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                    <Setter TargetName="border" Property="Background" Value="{StaticResource ButtonHoverBrush}"/>
                                    <Setter Property="Visibility" TargetName="PlaceholderText" Value="Collapsed"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="BorderBrush" Value="{StaticResource CardBorderColor}"/>
                                </Trigger>
                                <Trigger Property="Text" Value="{x:Null}">
                                    <Setter Property="Visibility" TargetName="PlaceholderText" Value="Visible"/>
                                </Trigger>
                                <Trigger Property="Text" Value="">
                                    <Setter Property="Visibility" TargetName="PlaceholderText" Value="Visible"/>
                                </Trigger>
                                <MultiTrigger>
                                    <MultiTrigger.Conditions>
                                        <Condition Property="IsFocused" Value="True"/>
                                        <Condition Property="Text" Value=""/>
                                    </MultiTrigger.Conditions>
                                    <Setter Property="Visibility" TargetName="PlaceholderText" Value="Collapsed"/>
                                </MultiTrigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="RadioButtonCardStyle" TargetType="RadioButton">
                <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                <Setter Property="Background" Value="{StaticResource CardBackgroundColor}"/>
                <Setter Property="BorderBrush" Value="{StaticResource CardBorderColor}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="Padding" Value="0"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Margin" Value="4"/>
                <Setter Property="HorizontalContentAlignment" Value="Center"/>
                <Setter Property="VerticalContentAlignment" Value="Center"/>
                <Setter Property="Width" Value="95"/>
                <Setter Property="Height" Value="105"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="RadioButton">
                            <Border x:Name="border"
                                        Background="{TemplateBinding Background}"
                                        BorderBrush="{TemplateBinding BorderBrush}"
                                        BorderThickness="{TemplateBinding BorderThickness}"
                                        CornerRadius="4">
                                <ContentPresenter Margin="{TemplateBinding Padding}" HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsChecked" Value="True">
                                    <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                    <Setter TargetName="border" Property="BorderThickness" Value="2"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource ButtonHoverBrush}"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="ScrollBarThumbStyle" TargetType="{x:Type Thumb}">
                <Setter Property="SnapsToDevicePixels" Value="True"/>
                <Setter Property="OverridesDefaultStyle" Value="true"/>
                <Setter Property="IsTabStop" Value="false"/>
                <Setter Property="Focusable" Value="false"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type Thumb}">
                            <Border Name="ThumbVisual" CornerRadius="3"
                                    Background="{StaticResource ScrollBarThumbBrush}"
                                    BorderBrush="Transparent" BorderThickness="0" />
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="ThumbVisual" Property="Background" Value="{StaticResource ScrollBarThumbHoverBrush}" />
                                </Trigger>
                                <Trigger Property="IsDragging" Value="True">
                                    <Setter TargetName="ThumbVisual" Property="Background" Value="{StaticResource BorderAccentColor}" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="ScrollBarPageButtonStyle" TargetType="{x:Type RepeatButton}">
                <Setter Property="SnapsToDevicePixels" Value="True"/>
                <Setter Property="OverridesDefaultStyle" Value="true"/>
                <Setter Property="IsTabStop" Value="false"/>
                <Setter Property="Focusable" Value="false"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type RepeatButton}">
                            <Border Background="Transparent" />
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style TargetType="{x:Type ScrollBar}">
                <Setter Property="SnapsToDevicePixels" Value="True"/>
                <Setter Property="OverridesDefaultStyle" Value="true"/>
                <Setter Property="Width" Value="12"/>
                <Setter Property="MinWidth" Value="12"/>
                <Setter Property="Background" Value="{StaticResource ScrollBarBackgroundBrush}"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type ScrollBar}">
                            <Grid Name="Bg" SnapsToDevicePixels="true" Background="{TemplateBinding Background}">
                                <Track x:Name="PART_Track" IsDirectionReversed="true" Width="Auto" HorizontalAlignment="Stretch">
                                    <Track.DecreaseRepeatButton>
                                        <RepeatButton Style="{StaticResource ScrollBarPageButtonStyle}" Command="ScrollBar.PageUpCommand" />
                                    </Track.DecreaseRepeatButton>
                                    <Track.Thumb>
                                        <Thumb Style="{StaticResource ScrollBarThumbStyle}" Margin="2,0,2,0" />
                                    </Track.Thumb>
                                    <Track.IncreaseRepeatButton>
                                        <RepeatButton Style="{StaticResource ScrollBarPageButtonStyle}" Command="ScrollBar.PageDownCommand" />
                                    </Track.IncreaseRepeatButton>
                                </Track>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Style.Triggers>
                    <Trigger Property="Orientation" Value="Horizontal">
                        <Setter Property="Width" Value="Auto"/>
                        <Setter Property="MinWidth" Value="0"/>
                        <Setter Property="Height" Value="12"/>
                        <Setter Property="MinHeight" Value="12"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="{x:Type ScrollBar}">
                                    <Grid Name="Bg" SnapsToDevicePixels="true" Background="{TemplateBinding Background}">
                                        <Track x:Name="PART_Track" IsDirectionReversed="False" Height="Auto" VerticalAlignment="Stretch">
                                            <Track.DecreaseRepeatButton>
                                                <RepeatButton Style="{StaticResource ScrollBarPageButtonStyle}" Command="ScrollBar.PageLeftCommand" />
                                            </Track.DecreaseRepeatButton>
                                            <Track.Thumb>
                                                <Thumb Style="{StaticResource ScrollBarThumbStyle}" Margin="0,2,0,2" />
                                            </Track.Thumb>
                                            <Track.IncreaseRepeatButton>
                                                <RepeatButton Style="{StaticResource ScrollBarPageButtonStyle}" Command="ScrollBar.PageRightCommand" />
                                            </Track.IncreaseRepeatButton>
                                        </Track>
                                    </Grid>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Trigger>
                </Style.Triggers>
            </Style>

            <Style x:Key="NavButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Foreground" Value="{StaticResource ForegroundGray}"/>
                <Setter Property="Width" Value="Auto"/>
                <Setter Property="MinWidth" Value="80"/>
                <Setter Property="Padding" Value="8,5"/>
                <Setter Property="Margin" Value="10,0"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="border" Background="Transparent" Padding="{TemplateBinding Padding}" CornerRadius="4">
                                <StackPanel Orientation="Vertical" HorizontalAlignment="Center">
                                    <Path x:Name="iconPath" Data="{Binding Tag, RelativeSource={RelativeSource TemplatedParent}}" Fill="{TemplateBinding Foreground}" Width="22" Height="22" Stretch="Uniform" Margin="0,0,0,4"/>
                                    <TextBlock x:Name="buttonText" Text="{TemplateBinding Content}" FontSize="11" FontWeight="Normal" TextAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                                    <Setter TargetName="iconPath" Property="Fill" Value="{StaticResource ForegroundColor}"/>
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter Property="Foreground" Value="{StaticResource BorderAccentColor}"/>
                                    <Setter TargetName="iconPath" Property="Fill" Value="{StaticResource BorderAccentColor}"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Opacity" Value="0.5"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="ComboBoxToggleButton" TargetType="ToggleButton">
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="ToggleButton">
                            <Border x:Name="border" Background="Transparent" BorderBrush="Transparent" BorderThickness="0">
                                <Path x:Name="arrow" Data="M0,0 L4,4 L8,0 Z" Fill="{StaticResource ForegroundGray}" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="arrow" Property="Fill" Value="{StaticResource ForegroundLightGray}"/>
                                </Trigger>
                                <Trigger Property="IsChecked" Value="True">
                                    <Setter TargetName="arrow" Property="Fill" Value="{StaticResource BorderAccentColor}"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter TargetName="arrow" Property="Fill" Value="{StaticResource ButtonDisabledBrush}"/>
                                    <Setter Property="Opacity" Value="0.5"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="ComboBoxStyle" TargetType="{x:Type ComboBox}">
                <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                <Setter Property="Background" Value="{StaticResource CardBackgroundColor}"/>
                <Setter Property="BorderBrush" Value="{StaticResource CardBorderColor}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="Padding" Value="8,0"/>
                <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled"/>
                <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto"/>
                <Setter Property="SnapsToDevicePixels" Value="True"/>
                <Setter Property="VerticalContentAlignment" Value="Center"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type ComboBox}">
                            <Grid x:Name="MainGrid" SnapsToDevicePixels="true">
                                <Border x:Name="MainBorder" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="3"/>
                                <ToggleButton x:Name="ToggleButton"
                                              Style="{StaticResource ComboBoxToggleButton}"
                                              IsChecked="{Binding Path=IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                              ClickMode="Press"
                                              Focusable="False"
                                              HorizontalAlignment="Stretch"
                                              VerticalAlignment="Stretch"/>
                                <ContentPresenter x:Name="ContentSite"
                                                  HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                  IsHitTestVisible="false"
                                                  Margin="{TemplateBinding Padding}"
                                                  VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                  Content="{TemplateBinding SelectionBoxItem}"
                                                  ContentStringFormat="{TemplateBinding SelectionBoxItemStringFormat}"
                                                  ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                                  ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}"
                                                  SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                <Popup x:Name="PART_Popup" AllowsTransparency="true" IsOpen="{Binding Path=IsDropDownOpen, RelativeSource={RelativeSource TemplatedParent}}" PopupAnimation="{DynamicResource {x:Static SystemParameters.ComboBoxPopupAnimationKey}}" Placement="Bottom">
                                    <Grid x:Name="DropDown" SnapsToDevicePixels="True" MinWidth="{Binding Path=ActualWidth, ElementName=MainGrid}" MaxHeight="{TemplateBinding MaxDropDownHeight}">
                                        <Border x:Name="DropDownBorder" Background="{StaticResource CardBackgroundColor}" BorderThickness="1" BorderBrush="{StaticResource BorderAccentColor}" CornerRadius="3"/>
                                        <ScrollViewer x:Name="DropDownScrollViewer">
                                            <StackPanel IsItemsHost="true" KeyboardNavigation.DirectionalNavigation="Contained"/>
                                        </ScrollViewer>
                                    </Grid>
                                </Popup>
                            </Grid>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="BorderBrush" TargetName="MainBorder" Value="{StaticResource CardBorderColor}"/>
                                </Trigger>
                                <Trigger Property="IsDropDownOpen" Value="True">
                                    <Setter Property="BorderBrush" TargetName="MainBorder" Value="{StaticResource BorderAccentColor}"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundGray}"/>
                                    <Setter Property="Opacity" TargetName="MainBorder" Value="0.6"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style TargetType="{x:Type ComboBoxItem}">
                <Setter Property="SnapsToDevicePixels" Value="True"/>
                <Setter Property="Padding" Value="8,6"/>
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type ComboBoxItem}">
                            <Border x:Name="Bd" Padding="{TemplateBinding Padding}" SnapsToDevicePixels="true" Background="{TemplateBinding Background}" CornerRadius="3">
                                <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsHighlighted" Value="True">
                                    <Setter TargetName="Bd" Property="Background" Value="{StaticResource BorderAccentColor}"/>
                                    <Setter Property="Foreground" Value="WhiteSmoke"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Foreground" Value="{StaticResource ForegroundGray}"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="ModernCheckBoxStyle" TargetType="CheckBox">
                <Setter Property="Foreground" Value="{StaticResource ForegroundColor}"/>
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderBrush" Value="{StaticResource CardBorderColor}"/>
                <Setter Property="BorderThickness" Value="1.5"/>
                <Setter Property="Padding" Value="5,2"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="CheckBox">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="checkBoxBorder" Grid.Column="0"
                                        Width="18" Height="18"
                                        Background="{TemplateBinding Background}"
                                        BorderBrush="{TemplateBinding BorderBrush}"
                                        BorderThickness="{TemplateBinding BorderThickness}"
                                        CornerRadius="3">
                                    <Path x:Name="checkMark" Visibility="Collapsed" Width="10" Height="10"
                                          Stretch="Fill" Fill="{StaticResource BorderAccentColor}"
                                          Data="M 0 5 L 3 10 L 10 0 L 10 2 L 3 10 L 0 7 Z"/>
                                </Border>
                                <ContentPresenter Grid.Column="1" Margin="8,0,0,0"
                                                  HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                  VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                  RecognizesAccessKey="True"/>
                            </Grid>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsChecked" Value="True">
                                    <Setter TargetName="checkMark" Property="Visibility" Value="Visible"/>
                                    <Setter TargetName="checkBoxBorder" Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                    <Setter TargetName="checkBoxBorder" Property="Background" Value="{StaticResource HeaderBackgroundColor}"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="checkBoxBorder" Property="BorderBrush" Value="{StaticResource BorderAccentColor}"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Opacity" Value="0.5"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

        </ResourceDictionary>
    </Application.Resources>
</Application>
/// Root End of App.xaml ///

/// Root Start of App.xaml.cs ///
﻿using Microsoft.Extensions.DependencyInjection;
using SkinHunterWPF.Services;
using SkinHunterWPF.ViewModels;
using System;
using System.Windows;

namespace SkinHunterWPF
{
    public partial class App : System.Windows.Application
    {
        public static IServiceProvider? ServiceProvider { get; private set; }

        protected override void OnStartup(StartupEventArgs e)
        {
            try
            {
                base.OnStartup(e);

                var serviceCollection = new ServiceCollection();
                ConfigureServices(serviceCollection);
                ServiceProvider = serviceCollection.BuildServiceProvider();

                var mainWindow = ServiceProvider.GetRequiredService<MainWindow>();
                mainWindow.DataContext = ServiceProvider.GetRequiredService<MainViewModel>();
                mainWindow.Show();
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show($"Error fatal durante el inicio:\n\n{ex.ToString()}",
                                "Error de Inicio",
                                MessageBoxButton.OK,
                                MessageBoxImage.Error);
                System.Diagnostics.Debug.WriteLine($"STARTUP ERROR: {ex}");
            }
        }

        private void ConfigureServices(IServiceCollection services)
        {
            services.AddSingleton<MainViewModel>();
            services.AddSingleton<INavigationService>(sp => new NavigationService(sp));
            services.AddTransient<ChampionGridViewModel>();
            services.AddTransient<ChampionDetailViewModel>();
            services.AddTransient<SkinDetailViewModel>();
            services.AddTransient<OmnisearchViewModel>();
            services.AddSingleton<MainWindow>(sp => new MainWindow(sp));
        }
    }
}
/// Root End of App.xaml.cs ///

/// Root Start of MainWindow.xaml ///
﻿<Window x:Class="SkinHunterWPF.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:SkinHunterWPF.ViewModels"
        xmlns:v="clr-namespace:SkinHunterWPF.Views"
        xmlns:converters="clr-namespace:SkinHunterWPF.Converters"
        mc:Ignorable="d"
        Title="Skin Hunter" Height="720" Width="1280" MinHeight="600" MinWidth="1000"
        WindowStartupLocation="CenterScreen"
        Background="Transparent"
        Foreground="{StaticResource ForegroundColor}"
        WindowStyle="None" AllowsTransparency="True" ResizeMode="CanResizeWithGrip">

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="35" ResizeBorderThickness="8" GlassFrameThickness="0" CornerRadius="0" UseAeroCaptionButtons="False"/>
    </WindowChrome.WindowChrome>

    <Border Background="{StaticResource HeaderBackgroundColor}"
            CornerRadius="8"
            Padding="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="{StaticResource HeaderBackgroundColor}" Height="60" MouseLeftButtonDown="TitleBar_MouseLeftButtonDown" CornerRadius="7,7,0,0">
                <DockPanel LastChildFill="True">
                    <Border DockPanel.Dock="Bottom" Height="1.5" Background="{StaticResource BorderAccentColor}" Margin="0"/>
                    <Grid Margin="15,0,10,0">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                            <Image Source="pack://application:,,,/Assets/logo.png" Height="30" VerticalAlignment="Center" Margin="0,0,10,0" RenderOptions.BitmapScalingMode="Fant"/>
                            <TextBlock Text="SKIN-HUNTER" Foreground="{StaticResource ForegroundColor}" VerticalAlignment="Center" FontSize="20" FontWeight="SemiBold" />
                        </StackPanel>
                        <TextBlock Text="initializing"
                                   Visibility="{Binding CurrentViewModel.IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"
                                   Foreground="{StaticResource ForegroundGray}" VerticalAlignment="Center" HorizontalAlignment="Center" FontSize="12" FontStyle="Italic"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Button Style="{StaticResource TitleBarButtonStyle}" Click="MinimizeButton_Click" ToolTip="Minimize" >
                                <Path Data="M0,5 H10 V7 H0 Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" Width="10" Height="10" Stretch="None"/>
                            </Button>
                            <Button x:Name="MaximizeButton" Style="{StaticResource TitleBarButtonStyle}" Click="MaximizeButton_Click" ToolTip="Maximize / Restore">
                                <Path x:Name="MaximizeIconPath" Data="M0,0 H10 V10 H0 Z M2,2 V8 H8 V2 Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" Width="10" Height="10" Stretch="None"/>
                            </Button>
                            <Button Style="{StaticResource CloseButtonStyle}" Click="CloseButton_Click" ToolTip="Close">
                                <Path Data="M0,0 L10,10 M10,0 L0,10" Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" StrokeThickness="1.5" Width="10" Height="10" Stretch="None"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </DockPanel>
            </Border>

            <ScrollViewer Grid.Row="1"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Background="Transparent" 
                          Padding="0" Focusable="False">
                <ContentControl x:Name="MainContentControl"
                                Content="{Binding CurrentViewModel}"
                                HorizontalContentAlignment="Stretch"
                                VerticalContentAlignment="Stretch"
                                Margin="66,0,66,0"
                                Background="{StaticResource WindowBackgroundColor}">
                    <ContentControl.Resources>
                        <DataTemplate DataType="{x:Type vm:ChampionGridViewModel}">
                            <v:ChampionGridView/>
                        </DataTemplate>
                        <DataTemplate DataType="{x:Type vm:ChampionDetailViewModel}">
                            <v:ChampionDetailView/>
                        </DataTemplate>
                    </ContentControl.Resources>
                </ContentControl>
            </ScrollViewer>

            <Border Grid.Row="2" Background="{StaticResource HeaderBackgroundColor}" Padding="0" CornerRadius="0,0,7,7">
                <DockPanel LastChildFill="True">
                    <Border DockPanel.Dock="Top" Height="1.5" Background="{StaticResource BorderAccentColor}" Margin="0"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,7,0,7">
                        <Button Style="{StaticResource NavButtonStyle}" Content="Champions" Command="{Binding NavigateToChampionsCommand}"
                                Tag="M3,3H11V11H3V3M13,3H21V11H13V3M3,13H11V21H3V13M13,13H21V21H13V13Z"/>
                        <Button Style="{StaticResource NavButtonStyle}" Content="Search" Command="{Binding OpenSearchCommand}" 
                            Tag="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L21.5,20L20,21.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                            <Button Style="{StaticResource NavButtonStyle}" Content="Installed" Command="{Binding NavigateToInstalledCommand}"
                                Tag="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                            <Button Style="{StaticResource NavButtonStyle}" Content="Profile" Command="{Binding OpenProfileCommand}"
                                Tag="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                    </StackPanel>
                </DockPanel>
            </Border>

            <Grid Grid.Row="0" Grid.RowSpan="3" Background="#CC121212"
                  Visibility="{Binding DialogViewModel, Converter={StaticResource NullToVisibilityConverter}, FallbackValue=Collapsed}">
                <ContentControl Content="{Binding DialogViewModel}" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ContentControl.Resources>
                        <DataTemplate DataType="{x:Type vm:SkinDetailViewModel}">
                            <v:SkinDetailDialog/>
                        </DataTemplate>
                    </ContentControl.Resources>
                </ContentControl>
            </Grid>

            <Grid Grid.Row="0" Grid.RowSpan="3" Background="#DD0A0A0A"
                  Visibility="{Binding OmnisearchDialogViewModel, Converter={StaticResource NullToVisibilityConverter}, FallbackValue=Collapsed}">
                <ContentControl Content="{Binding OmnisearchDialogViewModel}" 
                                HorizontalAlignment="Center" 
                                VerticalAlignment="Center">
                    <ContentControl.Resources>
                        <DataTemplate DataType="{x:Type vm:OmnisearchViewModel}">
                            <v:OmnisearchDialog/>
                        </DataTemplate>
                    </ContentControl.Resources>
                </ContentControl>
            </Grid>

        </Grid>
    </Border>
</Window>
/// Root End of MainWindow.xaml ///

/// Root Start of MainWindow.xaml.cs ///
﻿using System;
using System.Windows;
using System.Windows.Input;
using System.Windows.Forms;
using System.Drawing;
using SkinHunterWPF.ViewModels;
using SkinHunterWPF.Services; // AÑADIR ESTE USING
using System.IO;
using System.Diagnostics;
using Microsoft.Extensions.DependencyInjection;
using System.Threading.Tasks;

namespace SkinHunterWPF
{
    public partial class MainWindow : Window
    {
        private NotifyIcon? _notifyIcon;
        private bool _isExplicitClose = false;
        private bool _notifyIconInitializedSuccessfully = false;
        private readonly IServiceProvider _serviceProvider;
        private int? _lastChampionIdFromDetailView = null;


        public MainWindow(IServiceProvider serviceProvider)
        {
            Debug.WriteLine("[MainWindow] Constructor INICIADO.");
            InitializeComponent();
            _serviceProvider = serviceProvider;
            Debug.WriteLine("[MainWindow] InitializeComponent COMPLETADO.");
            SetupNotifyIcon();
            Debug.WriteLine("[MainWindow] SetupNotifyIcon LLAMADO desde el constructor.");
            MaximizeButton.IsEnabled = false;
            this.Loaded += MainWindow_Loaded;
            Debug.WriteLine("[MainWindow] Constructor FINALIZADO.");
        }

        private async void MainWindow_Loaded(object sender, RoutedEventArgs e)
        {
            Debug.WriteLine("[MainWindow] MainWindow_Loaded INICIADO.");
            if (DataContext is MainViewModel mvm)
            {
                await mvm.EnsureInitialDataLoadedAsync();
            }
            Debug.WriteLine("[MainWindow] MainWindow_Loaded FINALIZADO.");
        }

        private void MinimizeToTray()
        {
            Debug.WriteLine("[MainWindow] Minimizando a la bandeja...");
            this.Hide();
            if (_notifyIcon != null) _notifyIcon.Visible = true;

            if (DataContext is MainViewModel mainVM)
            {
                if (mainVM.CurrentViewModel is ChampionGridViewModel cgvm)
                {
                    Debug.WriteLine("[MainWindow] Llamando a ReleaseResourcesForTray en ChampionGridViewModel.");
                    cgvm.ReleaseResourcesForTray();
                }
                else if (mainVM.CurrentViewModel is ChampionDetailViewModel cdvm)
                {
                    Debug.WriteLine("[MainWindow] Llamando a ReleaseResourcesForTray en ChampionDetailViewModel.");
                    _lastChampionIdFromDetailView = cdvm.Champion?.Id;
                    cdvm.ReleaseResourcesForTray();
                }
            }

            GC.Collect(GC.MaxGeneration, GCCollectionMode.Forced, true);
            GC.WaitForPendingFinalizers();
            Debug.WriteLine("[MainWindow] Intento de liberación de recursos y GC invocado para bandeja.");
        }

        private async Task RestoreFromTrayAsync()
        {
            Debug.WriteLine("[MainWindow] Restaurando desde la bandeja...");
            if (_notifyIcon != null) _notifyIcon.Visible = false;

            this.Show();
            this.WindowState = WindowState.Normal;
            this.Activate();

            if (DataContext is MainViewModel mainVM)
            {
                Debug.WriteLine($"[MainWindow] ViewModel actual al restaurar: {mainVM.CurrentViewModel?.GetType().Name}");
                if (mainVM.CurrentViewModel is ChampionGridViewModel cgvm)
                {
                    Debug.WriteLine("[MainWindow] Recargando ChampionGridViewModel...");
                    if (cgvm.LoadChampionsCommand.CanExecute(null))
                        await cgvm.LoadChampionsCommand.ExecuteAsync(null);
                }
                else if (mainVM.CurrentViewModel is ChampionDetailViewModel cdvm)
                {
                    if (_lastChampionIdFromDetailView.HasValue)
                    {
                        Debug.WriteLine($"[MainWindow] Preparando para recargar ChampionDetailViewModel (ID guardado: {_lastChampionIdFromDetailView.Value})...");
                        cdvm.PrepareForReload();
                        if (cdvm.LoadChampionCommand.CanExecute(_lastChampionIdFromDetailView.Value))
                        {
                            Debug.WriteLine($"[MainWindow] Recargando ChampionDetailViewModel para ID: {_lastChampionIdFromDetailView.Value}.");
                            await cdvm.LoadChampionCommand.ExecuteAsync(_lastChampionIdFromDetailView.Value);
                        }
                        else
                        {
                            Debug.WriteLine($"[MainWindow] No se pudo ejecutar LoadChampionCommand para ChampionDetailViewModel ID: {_lastChampionIdFromDetailView.Value}. Volviendo a la cuadrícula.");
                            _serviceProvider.GetRequiredService<INavigationService>().NavigateTo<ChampionGridViewModel>();
                        }
                        _lastChampionIdFromDetailView = null;
                    }
                    else
                    {
                        Debug.WriteLine("[MainWindow] ChampionDetailViewModel no tenía un ID de campeón previo para recargar, volviendo a la cuadrícula.");
                        _serviceProvider.GetRequiredService<INavigationService>().NavigateTo<ChampionGridViewModel>();
                    }
                }
                else
                {
                    Debug.WriteLine("[MainWindow] No se reconoce el ViewModel actual o es null, navegando a la vista de campeones por defecto.");
                    _serviceProvider.GetRequiredService<INavigationService>().NavigateTo<ChampionGridViewModel>();
                }
            }
            Debug.WriteLine("[MainWindow] Ventana restaurada y ViewModel recargado (intento).");
        }

        private void SetupNotifyIcon()
        {
            Debug.WriteLine("[NotifyIcon] SetupNotifyIcon INICIADO.");
            string iconFileName = "icon.ico";
            string iconPath = "";
            try
            {
                iconPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Assets", iconFileName);
                Debug.WriteLine($"[NotifyIcon] Intentando cargar icono desde: {iconPath}");

                if (File.Exists(iconPath))
                {
                    Debug.WriteLine($"[NotifyIcon] Archivo '{iconPath}' EXISTE.");
                    _notifyIcon = new NotifyIcon
                    {
                        Text = "Skin Hunter",
                        Visible = false
                    };

                    try
                    {
                        _notifyIcon.Icon = new Icon(iconPath);
                        Debug.WriteLine("[NotifyIcon] Icono cargado y asignado exitosamente.");
                    }
                    catch (Exception exIcon)
                    {
                        Debug.WriteLine($"[NotifyIcon] EXCEPCIÓN al cargar Icon (archivo: {iconPath}): {exIcon.ToString()}. Asegúrate que '{iconFileName}' es un archivo .ico válido y accesible.");
                        _notifyIcon.Dispose();
                        _notifyIcon = null;
                        _notifyIconInitializedSuccessfully = false;
                        return;
                    }

                    _notifyIcon.DoubleClick += async (s, args) => await RestoreFromTrayAsync();

                    var contextMenu = new ContextMenuStrip();
                    contextMenu.Items.Add("Abrir Skin Hunter", null, async (s, args) => await RestoreFromTrayAsync());
                    contextMenu.Items.Add(new ToolStripSeparator());
                    contextMenu.Items.Add("Salir", null, (s, args) => ExitApplication());
                    _notifyIcon.ContextMenuStrip = contextMenu;

                    _notifyIconInitializedSuccessfully = true;
                    Debug.WriteLine("[NotifyIcon] NotifyIcon configurado completamente y marcado como exitoso.");
                }
                else
                {
                    Debug.WriteLine($"[NotifyIcon] ERROR CRÍTICO: El archivo '{iconPath}' NO FUE ENCONTRADO.");
                    _notifyIconInitializedSuccessfully = false;
                }
            }
            catch (Exception exSetup)
            {
                Debug.WriteLine($"[NotifyIcon] Excepción general en SetupNotifyIcon (fuera de la carga del Icon): {exSetup.ToString()}");
                _notifyIconInitializedSuccessfully = false;
                if (_notifyIcon != null)
                {
                    _notifyIcon.Dispose();
                    _notifyIcon = null;
                }
            }
            Debug.WriteLine($"[NotifyIcon] SetupNotifyIcon FINALIZADO. _notifyIconInitializedSuccessfully = {_notifyIconInitializedSuccessfully}");
        }

        private void ExitApplication()
        {
            Debug.WriteLine("[NotifyIcon] Salida explícita solicitada.");
            _isExplicitClose = true;
            _notifyIcon?.Dispose();
            System.Windows.Application.Current.Shutdown();
        }

        protected override void OnClosing(System.ComponentModel.CancelEventArgs e)
        {
            Debug.WriteLine($"[NotifyIcon] OnClosing: _isExplicitClose={_isExplicitClose}, _notifyIconInitializedSuccessfully={_notifyIconInitializedSuccessfully}");

            if (!_isExplicitClose && _notifyIconInitializedSuccessfully && _notifyIcon != null)
            {
                Debug.WriteLine("[NotifyIcon] OnClosing: Cancelando cierre, llamando a MinimizeToTray.");
                e.Cancel = true;
                MinimizeToTray();
            }
            else
            {
                Debug.WriteLine("[NotifyIcon] OnClosing: Cierre normal o NotifyIcon no listo/inicializado. Realizando dispose.");
                _notifyIcon?.Dispose();
            }
            base.OnClosing(e);
        }

        private void TitleBar_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (e.ButtonState == MouseButtonState.Pressed)
                this.DragMove();
        }

        private void MinimizeButton_Click(object sender, RoutedEventArgs e)
        {
            this.WindowState = WindowState.Minimized;
        }

        private void MaximizeButton_Click(object sender, RoutedEventArgs e)
        {
        }

        private void CloseButton_Click(object sender, RoutedEventArgs e)
        {
            Debug.WriteLine("[MainWindow] Botón X presionado, llamando a this.Close().");
            this.Close();
        }

        protected override void OnStateChanged(EventArgs e)
        {
            var maximizeIcon = MaximizeIconPath;
            if (maximizeIcon != null)
            {
                if (this.WindowState == WindowState.Maximized)
                {
                    maximizeIcon.Data = System.Windows.Media.Geometry.Parse("M2,0 H8 V2 H0 V10 H2 V8 H10 V2 H8 Z M3,3 V7 H7 V3Z");
                }
                else
                {
                    maximizeIcon.Data = System.Windows.Media.Geometry.Parse("M0,0 H10 V10 H0 Z M2,2 V8 H8 V2 Z");
                }
            }
            base.OnStateChanged(e);
        }
    }
}
/// Root End of MainWindow.xaml.cs ///

